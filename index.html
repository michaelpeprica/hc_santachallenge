<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>V√°noƒçn√≠ v√Ωzva 2025 ‚Ä¢ Home Credit</title>
  <style>
    :root{
      --bg: #0c1222;
      --bg-soft:#111a33;
      --card:#152043;
      --text:#e7f0ff;
      --muted:#a3b0c7;
      --accent:#e64564;
      --accent-2:#2ad1ff;
      --success:#35d399;
      --warn:#f59e0b;
      --shadow: 0 10px 25px rgba(0,0,0,.25);
      --xmas-grad: linear-gradient(90deg, #c81e1e, #16a34a);
    }
    [data-theme="light"]{
      --bg: #f5f7fb; --bg-soft:#ffffff; --card:#ffffff; --text:#1b2430; --muted:#556072; --accent:#c2185b; --accent-2:#0ea5e9; --success:#16a34a; --warn:#d97706;
    }
    html,body{height:100%;}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text);} 
    .app-wrap{min-height:100%; display:grid; grid-template-rows:auto 1fr auto;}
    header{position:sticky; top:0; z-index:20; display:flex; align-items:center; gap:.75rem; justify-content:space-between; padding:12px 16px; background:linear-gradient(180deg, rgba(0,0,0,.25), transparent), var(--bg-soft); box-shadow:var(--shadow);}  
    header .brand{display:flex; align-items:center; gap:.75rem;}
    .brand .logo{width:36px; height:36px; border-radius:10px; background: var(--xmas-grad); box-shadow:0 6px 20px rgba(230,69,100,.35);} 
    .brand h1{font-size:1.05rem; margin:0; letter-spacing:.3px}
    header nav{display:flex; gap:.5rem; align-items:center}
    button, .btn{appearance:none; border:none; outline:none; border-radius:14px; padding:.6rem .9rem; background:var(--accent); color:white; font-weight:600; cursor:pointer; box-shadow:var(--shadow);}    
    .btn.secondary{background:var(--card); color:var(--text); border:1px solid rgba(255,255,255,.08)}
    .btn.ghost{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.15)}
    .btn.small{padding:.45rem .7rem; border-radius:12px; font-size:.875rem}

    main{position:relative; z-index:1; padding:16px; display:grid; gap:16px; max-width:1100px; margin-inline:auto}

    .card{background:var(--card); border-radius:22px; padding:16px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,.06)}
    .card h2{margin:.3rem 0 0.75rem 0; font-size:1.05rem}

    .muted{color:var(--muted); font-size:.9rem}

    .stack{display:flex; flex-direction:column; gap:10px}
    .row{display:flex; gap:10px; align-items:center}

    .progress{height:14px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.08)); border-radius:999px; position:relative; overflow:hidden;}
    .progress .bar{height:100%; width:0%; background:var(--xmas-grad); transition:width .7s ease}

    .leaderboard-item{display:grid; grid-template-columns: 36px 52px 1fr auto; gap:12px; align-items:center} .medal-big{font-size:1.6rem; line-height:1;}
    .avatar{width:52px; height:52px; border-radius:15px; background: linear-gradient(45deg, #f5f5dc, #ffffff); display:grid; place-items:center; font-weight:800; color:black; overflow:hidden}
    .avatar img{width:100%; height:100%; object-fit:cover; display:block}
    .medal{font-size:1.25rem}

    .pill{display:inline-block; margin-left:.5rem; padding:.15rem .5rem; font-size:.75rem; border-radius:999px; background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.28)}

    .tabs{display:flex; gap:6px; flex-wrap:wrap}
    .tab{padding:.55rem .8rem; border-radius:12px; background:transparent; border:1px solid rgba(255,255,255,.15); cursor:pointer}
    .tab.active{background:var(--accent); color:white; border-color:transparent}

    .footer{opacity:.7; padding:10px 16px; font-size:.85rem}

    /* Snow canvas covers viewport */
    #snow{position:fixed; inset:0; pointer-events:none; z-index:0}

    /* Auth screen */
    .auth{max-width:560px; margin: 4vh auto;}
    .auth h2{margin-top:0}
    .input{background:var(--bg); border:1px solid rgba(255,255,255,.12); color:var(--text); padding:.7rem .8rem; border-radius:12px; width:100%}
    label{font-size:.85rem; color:var(--muted)}
    form .row{justify-content:space-between}

    /* Festive background (simple vector hills) */
    .bg-illustration{position:fixed; inset:0; z-index:0; opacity:.25; background:
      radial-gradient(60% 35% at 50% 105%, rgba(255,255,255,.35), transparent 70%),
      linear-gradient(to top, #0b1330 0%, transparent 60%),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1920" height="800" viewBox="0 0 1920 800"><defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop stop-color="%23ffffff" stop-opacity="0.6"/><stop offset="1" stop-color="%23ffffff" stop-opacity="0.15"/></linearGradient></defs><g fill="url(%23g)"><path d="M0 650 C300 590 420 620 700 650 C980 680 1100 630 1400 600 C1700 570 1820 610 1920 640 L1920 800 L0 800 Z"/><path d="M0 720 C300 680 450 700 740 720 C1030 740 1220 710 1500 690 C1780 670 1870 700 1920 730 L1920 800 L0 800 Z"/></g></svg>') center bottom / cover no-repeat;
    }

    .hidden{display:none}
  </style>
</head>
<body>
  <canvas id="snow"></canvas>
  <div class="bg-illustration" aria-hidden="true"></div>
  <div class="app-wrap" id="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>V√°noƒçn√≠ v√Ωzva 2025</h1>
      </div>
      <nav>
        <button class="btn small" id="mapBtn" title="Mapa">üó∫Ô∏è Mapa</button>
        <button class="btn small" id="milestonesBtn" title="Hodnosti">üèÜ Hodnosti</button>
        <button class="btn small" id="avatarBtn" title="Zvolit profilov√Ω obr√°zek">üñºÔ∏è Avatar</button>
        <button class="btn small" id="themeToggle" title="P≈ôepnout t√©ma">üåì T√©ma</button>
        <button class="btn small ghost" id="signOutBtn" title="Odhl√°sit">Odhl√°sit</button>
      </nav>
    </header>

    <main>
      <!-- Weekly info (NEW) -->
      <section id="weekInfoSection" class="card hidden">
        <h2>Tento t√Ωden</h2>
        <div id="weekInfoTextView" class="muted"></div>
        <div id="weekInfoActivities" class="stack"></div>
      </section>

      <!-- Auth screen -->
      <section id="authSection" class="auth card">
        <h2>P≈ôihl√°≈°en√≠</h2>
        <p class="muted">Pou≈æijte firemn√≠ e-mail; prvn√≠ p≈ôihl√°≈°en√≠ vytvo≈ô√≠ v√°≈° profil (role p≈ôi≈ôad√≠ vedouc√≠).</p>
        <form id="authForm" class="stack">
          <div class="stack">
            <label for="email">E-mail</label>
            <input id="email" class="input" type="email" required placeholder="jan.novak@homecredit.cz" />
          </div>
          <div class="stack">
            <label for="password">Heslo</label>
            <input id="password" class="input" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          <div class="row">
            <button class="btn" type="submit">P≈ôihl√°sit / Registrovat</button>
            <button class="btn secondary" id="resetPass" type="button">Reset hesla</button>
          </div>
        </form>
      </section>

      <!-- Operator: quick self points -->
      <section id="operatorSection" class="card hidden" aria-hidden="true">
        <h2>Moje aktivity</h2>
        <div class="stack">
          <div class="row">
            <select id="targetOperator" class="input hidden" style="max-width:280px"></select>
            <select id="activitySelect" class="input" style="max-width:420px"></select>
            <input type="number" id="customDelta" class="input" placeholder="Vlastn√≠ poƒçet (¬±)" style="max-width:180px" />
            <button class="btn" id="addPointsBtn" disabled>P≈ôidat/Odebrat body</button>
          </div>
          <p class="muted" id="roleInfo"></p>
          <div id="myRecent" class="stack"></div>
        </div>
      </section>

      <!-- Leaderboard -->
      <section id="leaderboardSection" class="card hidden">
        <h2>≈Ωeb≈ô√≠ƒçek</h2>
        <div class="row muted" style="justify-content:space-between">
          <div>Body = nasb√≠ran√© d√°rky üéÅ</div>
          <div id="milestoneLegend"></div>
        </div>
        <div id="leaderboard" class="stack"></div>
      </section>

      <!-- Manager controls -->
      <section id="managerSection" class="hidden">
        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="cfg-activities">Aktivity</button>
          <button class="tab" data-tab="cfg-milestones">Hodnosti</button>
          <button class="tab" data-tab="cfg-roles">Oper√°to≈ôi</button>
          <button class="tab" data-tab="cfg-utils">N√°stroje</button>
        </div>

        <div id="cfg-activities" class="card tabpanel">
          <h2>Nastaven√≠ aktivit</h2>
          <div class="row">
            <input id="actName" class="input" placeholder="N√°zev aktivity"/>
            <select id="actCategory" class="input">
              <option value="tel_weekly">Telefonie ‚Äì t√Ωdenn√≠</option>
              <option value="kore_static">Korespondence ‚Äì st√°l√©</option>
            </select>
            <input id="actPoints" class="input" type="number" placeholder="Body za splnƒõn√≠"/>
            <input id="actWeek" class="input" type="week" placeholder="T√Ωden (YYYY-Www)" title="Platnost pro t√Ωden (povinn√© pro t√Ωdenn√≠ aktivity)">
            <input id="actDesc" class="input" placeholder="Kr√°tk√Ω popis (voliteln√©)"/>
            <button class="btn" id="addActivity">P≈ôidat</button>
          </div>
          <div id="activitiesList" class="stack" style="margin-top:8px"></div>
        </div>

        <div id="cfg-milestones" class="card tabpanel hidden">
          <h2>Hodnosti</h2>
          <div class="row" style="flex-wrap:wrap; gap:8px">
            <input id="msThreshold" class="input" type="number" placeholder="Poƒçet d√°rk≈Ø"/>
            <input id="msLabel" class="input" placeholder="Oznaƒçen√≠ (badge)"/>
            <input id="msReward" class="input" placeholder="V√Ωhra (voliteln√©)"/>
            <label class="row" style="gap:6px"><input type="checkbox" id="msVisible" checked /> Viditeln√Ω</label>
            <button class="btn" id="addMilestone">P≈ôidat miln√≠k</button>
          </div>
          <div class="muted">Tip: Hodnost m≈Ø≈æete n√≠≈æe upravit (pr√°h, n√°zev, v√Ωhra) a p≈ôep√≠nat viditelnost.</div>
          <div id="milestonesList" class="stack" style="margin-top:8px"></div>
        </div>

        <div id="cfg-roles" class="card tabpanel hidden">
          <h2>Oper√°to≈ôi ‚Äì role a jm√©na</h2>
          <div class="row">
            <select id="userSelect" class="input" style="min-width:280px"></select>
            <input id="displayNameInput" class="input" placeholder="Jm√©no P≈ô√≠jmen√≠" style="min-width:220px"/>
            <select id="roleSelect" class="input">
              <option value="manager">manager</option>
              <option value="operator_tel">operator_tel</option>
              <option value="operator_tel_kore">operator_tel_kore</option>
              <option value="operator_kore">operator_kore</option>
            </select>
            <button class="btn" id="assignRole">Ulo≈æit</button>
          </div>
          <p class="muted">Role se ukl√°daj√≠ do kolekce <code>roles/{uid}</code>. Zmƒõna jm√©na se ukl√°d√° v <code>operators/{uid}.displayName</code>.</p>
          <div id="rolesList" class="stack" style="margin-top:8px"></div>
        </div>

        <div id="cfg-utils" class="card tabpanel hidden">
          <h2>N√°stroje</h2>
          <div class="stack">
            <div class="row">
              <button class="btn ghost" id="recomputeLeaderboard">P≈ôepoƒç√≠tat ≈æeb≈ô√≠ƒçek (klientsky)</button>
              <button class="btn ghost" id="refreshAudits">Naƒç√≠st Audit bod≈Ø</button>
            </div>
            <div class="stack">
              <label for="weeklyInfoManager">Kr√°tk√Ω popis pro sekci ‚ÄûTento t√Ωden‚Äù (podporuje **tuƒçn√©**, *kurz√≠va*, __podtr≈æen√≠__)</label>
              <textarea id="weeklyInfoManager" class="input" rows="3" placeholder="Nap≈ô. **D≈Øle≈æit√©**: tento t√Ωden bƒõ≈æ√≠ speci√°ln√≠ sprint‚Ä¶"></textarea>
              <div class="row" style="justify-content:flex-end"><button class="btn" id="saveWeekInfo">Ulo≈æit popis t√Ωdne</button></div>
            </div>
            <div id="auditsList" class="stack" style="margin-top:8px"></div>
          </div>
          <p class="muted">Pozn.: Bez Cloud Functions prob√≠h√° p≈ôepoƒçet na klientovi. ≈Ωeb≈ô√≠ƒçek se poƒç√≠t√° ze souƒçtu dokument≈Ø v <code>logs</code>. Audit se ukl√°d√° do <code>audits</code>.</p>
        </div>
      </section>

      <!-- Milestones modal -->
      <section id="milestonesModal" class="card hidden" style="position:fixed; right:16px; top:64px; z-index:10; max-width:420px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0">Hodnosti</h2>
          <button class="btn small ghost" id="closeMilestonesModal">Zav≈ô√≠t</button>
        </div>
        <div id="milestonesPublicList" class="stack"></div>
      </section>
      <!-- Avatar modal -->
      <section id="avatarModal" class="card hidden" style="position:fixed; right:16px; top:64px; z-index:30; max-width:520px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0">Vyber profilov√Ω obr√°zek</h2>
          <button class="btn small ghost" id="closeAvatarModal">Zav≈ô√≠t</button>
        </div>
        <div class="muted">Pokud ≈æ√°dn√Ω nevybere≈°, bude se zobrazovat ikona s inici√°lami s vlastn√≠ barvou.</div>
        <div id="avatarGrid" class="row" style="flex-wrap:wrap; gap:10px; margin-top:10px"></div>
      </section>

      <!-- Milestones modal -->
      <section id="milestonesModal" class="card hidden" style="position:fixed; right:16px; top:64px; z-index:10; max-width:420px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h2 style="margin:0">Hodnosti</h2>
          <button class="btn small ghost" id="closeMilestonesModal">Zav≈ô√≠t</button>
        </div>
        <div id="milestonesPublicList" class="stack"></div>
      </section>
    </main>

    <footer class="footer">¬© 2025 Home Credit ‚Ä¢ V√°noƒçn√≠ v√Ωzva ‚Ä¢ <span id="footerRole">Nep≈ôihl√°≈°en</span></footer>
  </div>

  <script type="module">
    // === Firebase bootstrap (modular v10) ===
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, query, where, orderBy, limit, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB3rsUPwZrAhSIUhNP5st0NnIoBR9nlpZE",
      authDomain: "santa-challenge.firebaseapp.com",
      projectId: "santa-challenge",
      storageBucket: "santa-challenge.firebasestorage.app",
      messagingSenderId: "499140073635",
      appId: "1:499140073635:web:6c82ed4fb5795b36174716"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);

    // === Theming ===
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(t){document.body.setAttribute('data-theme', t); localStorage.setItem('xx_theme', t);}    
    applyTheme(localStorage.getItem('xx_theme') || 'dark');
    themeToggle.addEventListener('click', ()=>{applyTheme((document.body.getAttribute('data-theme')==='dark')?'light':'dark')});

    // === Elements ===
    const weekInfoSection = document.getElementById('weekInfoSection');
    const weekInfoTextView = document.getElementById('weekInfoTextView');
    const weekInfoActivities = document.getElementById('weekInfoActivities');

    const authSection = document.getElementById('authSection');
    const operatorSection = document.getElementById('operatorSection');
    const managerSection = document.getElementById('managerSection');
    const leaderboardSection = document.getElementById('leaderboardSection');
    const signOutBtn = document.getElementById('signOutBtn');
    const footerRole = document.getElementById('footerRole');
    const roleInfo = document.getElementById('roleInfo');

    const authForm = document.getElementById('authForm');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const resetPass = document.getElementById('resetPass');

    const activitySelect = document.getElementById('activitySelect');
    const addPointsBtn = document.getElementById('addPointsBtn');
    const customDelta = document.getElementById('customDelta');
    const myRecent = document.getElementById('myRecent');
    const targetOperator = document.getElementById('targetOperator');

    const milestoneLegend = document.getElementById('milestoneLegend');
    const milestonesPublicList = document.getElementById('milestonesPublicList');
    const milestonesModal = document.getElementById('milestonesModal');
    const closeMilestonesModal = document.getElementById('closeMilestonesModal');
    const mapBtn = document.getElementById('mapBtn');
    const milestonesBtn = document.getElementById('milestonesBtn');
    const avatarBtn = document.getElementById('avatarBtn');
    const avatarModal = document.getElementById('avatarModal');
    const closeAvatarModal = document.getElementById('closeAvatarModal');
    const avatarGrid = document.getElementById('avatarGrid');
    const leaderboard = document.getElementById('leaderboard');

    // Manager UI
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.tabpanel');
    tabs.forEach(t=>t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      panels.forEach(p=>p.classList.add('hidden'));
      document.getElementById(t.dataset.tab).classList.remove('hidden');
    }));

    const actName = document.getElementById('actName');
    const actCategory = document.getElementById('actCategory');
    const actPoints = document.getElementById('actPoints');
    const actWeek = document.getElementById('actWeek');
    const actDesc = document.getElementById('actDesc');
    const addActivity = document.getElementById('addActivity');
    const activitiesList = document.getElementById('activitiesList');

    const msThreshold = document.getElementById('msThreshold');
    const msLabel = document.getElementById('msLabel');
    const msReward = document.getElementById('msReward');
    const msVisible = document.getElementById('msVisible');
    const addMilestone = document.getElementById('addMilestone');
    const milestonesList = document.getElementById('milestonesList');

    const userSelect = document.getElementById('userSelect');
    const roleSelect = document.getElementById('roleSelect');
    const rolesList = document.getElementById('rolesList');
    const displayNameInput = document.getElementById('displayNameInput');

    const recomputeLeaderboard = document.getElementById('recomputeLeaderboard');
    const refreshAudits = document.getElementById('refreshAudits');
    const auditsList = document.getElementById('auditsList');

    // Settings (weekly info)
    const weeklyInfoManager = document.getElementById('weeklyInfoManager');
    const saveWeekInfo = document.getElementById('saveWeekInfo');

    // Data helpers
    const ROLE_LABELS = {
      manager: 'Vedouc√≠',
      operator_tel: 'Oper√°tor ‚Äì telefonie',
      operator_tel_kore: 'Oper√°tor ‚Äì p≈Ølen√≠ (tel + kore)',
      operator_kore: 'Oper√°tor ‚Äì korespondence'
    };
    const OPERATOR_ROLES = new Set(['operator_tel','operator_kore','operator_tel_kore']);
    function allowedCategoriesFor(role){
      if(role==='operator_tel') return ['tel_weekly'];
      if(role==='operator_kore') return ['kore_static'];
      if(role==='operator_tel_kore') return ['tel_weekly','kore_static'];
      if(role==='manager') return ['tel_weekly','kore_static'];
      return [];
    }

    function includeActivityThisWeek(a, role, now){
      if(!a || !a.enabled) return false;
      if(!allowedCategoriesFor(role).includes(a.category)) return false;
      if(a.category==='tel_weekly'){
        const start = a.weekStart?.seconds ? new Date(a.weekStart.seconds*1000) : (a.weekStart ? new Date(a.weekStart) : null);
        const end = a.weekEnd?.seconds ? new Date(a.weekEnd.seconds*1000) : (a.weekEnd ? new Date(a.weekEnd) : null);
        return !!(start && end && now >= start && now <= end);
      }
      // static correspondence
      return true;
    }

    // === Week info rendering helpers ===
    function escapeHtml(str){
      return (str||'').replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    }
    function renderWeekInfoText(raw){
      let txt = escapeHtml(raw || '');
      // inline formatting (**bold**, *italic*, __underline__)
      txt = txt.replace(new RegExp("\\*\\*(.*?)\\*\\*", "g"), '<b>$1</b>');
      txt = txt.replace(new RegExp("\\*(.*?)\\*", "g"), '<i>$1</i>');
      txt = txt.replace(new RegExp("__(.*?)__", "g"), '<u>$1</u>');
      // paragraphs = split by two or more newlines; inside paragraph convert single \n to <br>
      const paras = txt.split(/\n\n+/).map(p => `<p>${p.replace(/\n/g,'<br>')}</p>`).join('');
      return paras || '<p></p>';
    }

    // Auth flow
    authForm.addEventListener('submit', async(e)=>{
      e.preventDefault();
      const email = emailEl.value.trim();
      const pass = passEl.value.trim();
      try {
        try { await signInWithEmailAndPassword(auth, email, pass); }
        catch { await createUserWithEmailAndPassword(auth, email, pass); }
      } catch(err){ alert('Chyba p≈ôihl√°≈°en√≠/registrace: '+(err?.message||err)); }
    });
    resetPass.addEventListener('click', async()=>{
      const email = emailEl.value.trim(); if(!email) return alert('Zadejte e-mail.');
      try{ await sendPasswordResetEmail(auth, email); alert('Odesl√°n reset hesla.'); }
      catch(err){ alert('Chyba: '+(err?.message||err)); }
    });
    signOutBtn.addEventListener('click', ()=> signOut(auth));

    let currentUser = null; let currentRole = null; let unsubscribeActs = null; let unsubscribeMs = null; let unsubscribeSettings = null; let currentOperatorProfile=null;

    onAuthStateChanged(auth, async(user)=>{
      currentUser = user;
      if(!user){
        [authSection, weekInfoSection].forEach(e=>e.classList.remove('hidden'));
        operatorSection.classList.add('hidden'); operatorSection.setAttribute('aria-hidden','true');
        managerSection.classList.add('hidden');
        leaderboardSection.classList.add('hidden');
        footerRole.textContent = 'Nep≈ôihl√°≈°en';
        targetOperator?.classList.add('hidden');
        addPointsBtn?.setAttribute('disabled','true');
        if(unsubscribeActs) unsubscribeActs();
        if(unsubscribeMs) unsubscribeMs();
        if(unsubscribeSettings) unsubscribeSettings();
        return;
      }
      // Ensure profile doc exists in operators/{uid}
      const opRef = doc(db, 'operators', user.uid);
      const opSnap = await getDoc(opRef);
      if(!opSnap.exists()){
        await setDoc(opRef, {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || user.email.split('@')[0],
          createdAt: serverTimestamp()
        });
        currentOperatorProfile = { uid:user.uid, email:user.email, displayName: user.displayName || user.email.split('@')[0] };
      }else{
        currentOperatorProfile = { id: opSnap.id, ...opSnap.data() };
      }
      // Fetch role from roles/{uid}
      const roleRef = doc(db, 'roles', user.uid);
      const roleSnap = await getDoc(roleRef);
      currentRole = roleSnap.exists() ? roleSnap.data().role : null;

      footerRole.textContent = currentRole ? `Role: ${ROLE_LABELS[currentRole] || currentRole}` : 'Role zat√≠m nep≈ôi≈ôazena';

      authSection.classList.add('hidden');
      leaderboardSection.classList.remove('hidden');
      weekInfoSection.classList.remove('hidden');

      if(currentRole==='manager'){
        managerSection.classList.remove('hidden');
        operatorSection.classList.remove('hidden');
        operatorSection.removeAttribute('aria-hidden');
        targetOperator.classList.remove('hidden');
        addPointsBtn?.removeAttribute('disabled');
      } else if(currentRole){
        operatorSection.classList.remove('hidden');
        operatorSection.removeAttribute('aria-hidden');
        managerSection.classList.add('hidden');
        targetOperator.classList.add('hidden');
        addPointsBtn?.removeAttribute('disabled');
      } else {
        operatorSection.classList.add('hidden');
        operatorSection.setAttribute('aria-hidden','true');
        managerSection.classList.add('hidden');
        addPointsBtn?.setAttribute('disabled','true');
      }

      roleInfo.innerHTML = currentRole ? `Va≈°e role: <b>${ROLE_LABELS[currentRole]}</b>` : 'ƒåek√°te na p≈ôi≈ôazen√≠ role vedouc√≠m.';

      if(saveWeekInfo){ saveWeekInfo.disabled = currentRole !== 'manager'; }
      if(currentRole==='manager'){ await ensureSettingsDocExists(); }

      await Promise.all([
        subscribeActivities(),
        subscribeMilestones(),
        buildUsersForManager(),
        refreshLeaderboard(),
        loadMyRecent(),
        subscribeWeekInfo(),
        populateTargetOperatorSelect()
      ]);

      if(currentRole==='manager'){
        await loadAudits();
      }
    });

    // === Activities ===
    async function subscribeActivities(){
      const qActs = query(collection(db,'activities'), orderBy('name'));
      unsubscribeActs = onSnapshot(qActs, (snap)=>{
        activitiesList.innerHTML = '';
        activitySelect.innerHTML = '';
        weekInfoActivities.innerHTML = '';
        const allowed = allowedCategoriesFor(currentRole);
        const now = new Date();
        const weeklyList = [];
        snap.forEach(d=>{
          const a = { id:d.id, ...d.data() };
          // Manager list row
          if(currentRole==='manager'){
            const row = document.createElement('div'); row.className='row';
            const start = a.weekStart?.seconds ? new Date(a.weekStart.seconds*1000) : (a.weekStart ? new Date(a.weekStart) : null);
            const end = a.weekEnd?.seconds ? new Date(a.weekEnd.seconds*1000) : (a.weekEnd ? new Date(a.weekEnd) : null);
            const weekInfo = (a.category==='tel_weekly') ? (a.week ? a.week : (start && end ? `${start.toLocaleDateString()} ‚Äì ${end.toLocaleDateString()}` : '<span class="muted">nenastaven t√Ωden</span>')) : '‚Äî';
            row.innerHTML = `
              <div class="card" style="flex:1; padding:10px; display:grid; grid-template-columns:1.2fr .6fr .8fr 1fr auto; gap:8px; align-items:center">
                <div><b>${a.name}</b><div class=\"muted\">${a.category}${a.desc? ' ‚Ä¢ '+a.desc: ''}</div></div>
                <div>${a.points} bod≈Ø</div>
                <div>${a.enabled? 'Aktivn√≠' : '<span class=\"muted\">Skryto</span>'}</div>
                <div>${weekInfo}</div>
                <div class="row">
                  <button class="btn small ghost" data-toggle="${a.id}">P≈ôepnout</button>
                  <button class="btn small ghost" data-editdesc="${a.id}">Upravit popis</button>
                  <button class="btn small ghost" data-del="${a.id}">Smazat</button>
                </div>
              </div>`;
            activitiesList.appendChild(row);
            row.querySelector('[data-toggle]')?.addEventListener('click', async()=>{
              await updateDoc(doc(db,'activities', a.id), { enabled: !a.enabled });
            });
            row.querySelector('[data-del]')?.addEventListener('click', async()=>{
              if(confirm('Smazat aktivitu?')) await deleteDoc(doc(db,'activities', a.id));
            });
            row.querySelector('[data-editdesc]')?.addEventListener('click', async()=>{
              const val = prompt('Nov√Ω kr√°tk√Ω popis:', a.desc||'');
              if(val!==null){ await updateDoc(doc(db,'activities', a.id), { desc: val.trim() }); }
            });
          }
          // Operator dropdown ‚Äì filter by allowed category + enabled + (for weekly) within week window
          if(a.enabled && allowed.includes(a.category)){
            let include = true;
            if(a.category==='tel_weekly'){
              const start2 = a.weekStart?.seconds ? new Date(a.weekStart.seconds*1000) : (a.weekStart ? new Date(a.weekStart) : null);
              const end2 = a.weekEnd?.seconds ? new Date(a.weekEnd.seconds*1000) : (a.weekEnd ? new Date(a.weekEnd) : null);
              include = !!(start2 && end2 && now >= start2 && now <= end2);
            }
            if(include){
              const opt = document.createElement('option');
              opt.value = a.id; opt.textContent = `${a.name} (+${a.points})`;
              opt.dataset.points = a.points;
              activitySelect.appendChild(opt);
            }
          }
          // Weekly info section list
          if(includeActivityThisWeek(a, currentRole, now)){
            weeklyList.push(a);
          }
        });
        // Render weekly info
        weeklyList.sort((x,y)=> x.category.localeCompare(y.category) || x.name.localeCompare(y.name));
        weeklyList.forEach(a=>{
          const start = a.weekStart?.seconds ? new Date(a.weekStart.seconds*1000) : (a.weekStart ? new Date(a.weekStart) : null);
          const end = a.weekEnd?.seconds ? new Date(a.weekEnd.seconds*1000) : (a.weekEnd ? new Date(a.weekEnd) : null);
          const meta = a.category==='tel_weekly' ? (a.week || (start && end ? `${start.toLocaleDateString()} ‚Äì ${end.toLocaleDateString()}` : '')) : 'st√°l√°';
          const card = document.createElement('div'); card.className='card';
          card.innerHTML = `
            <div class="row" style="justify-content:space-between; align-items:flex-start">
              <div>
                <div><b>${a.name}</b> <span class="muted">(${meta})</span></div>
                ${a.desc? `<div class=\"muted\">${a.desc}</div>`:''}
              </div>
              <div><b>${a.points}</b> b.</div>
            </div>`;
          weekInfoActivities.appendChild(card);
        });
      });
    }

    addActivity?.addEventListener('click', async()=>{
      if(!actName.value || !actPoints.value) return alert('Dopl≈àte n√°zev a body.');
      const cat = actCategory.value;
      function weekToRange(weekStr){
        try{
          if(!weekStr) return null;
          const parts = weekStr.split('-W');
          const year = Number(parts[0]); const week = Number(parts[1]);
          if(!year || !week) return null;
          const simple = new Date(Date.UTC(year,0,1+ (week-1)*7));
          const dow = (simple.getUTCDay()+6)%7; // Mon=0..Sun=6
          const mon = new Date(simple); mon.setUTCDate(simple.getUTCDate()-dow);
          const sun = new Date(mon); sun.setUTCDate(mon.getUTCDate()+6);
          const monLocal = new Date(mon.getUTCFullYear(), mon.getUTCMonth(), mon.getUTCDate());
          const sunLocal = new Date(sun.getUTCFullYear(), sun.getUTCMonth(), sun.getUTCDate(), 23,59,59,999);
          return {week: weekStr, weekStart: monLocal, weekEnd: sunLocal};
        } catch(e){ return null; }
      }
      const wk = actWeek.value ? weekToRange(actWeek.value) : null;
      if(cat==='tel_weekly' && !wk) return alert('Pro t√Ωdenn√≠ aktivitu vyberte t√Ωden.');
      try{
        await addDoc(collection(db,'activities'), {
          name: actName.value.trim(),
          category: cat,
          points: Number(actPoints.value),
          enabled: true,
          desc: (actDesc.value||'').trim(),
          ...(wk||{}),
          createdAt: serverTimestamp()
        });
        actName.value=''; actPoints.value=''; actWeek.value=''; actDesc.value='';
      }catch(e){ alert('Chyba p≈ôid√°n√≠: '+(e?.message||e)); }
    });

    // === Milestones ===
    async function subscribeMilestones(){
      const qMs = query(collection(db,'milestones'), orderBy('threshold'));
      unsubscribeMs = onSnapshot(qMs, (snap)=>{
        milestonesList.innerHTML = '';
        milestonesPublicList.innerHTML='';
        const items = []; snap.forEach(d=>items.push({id:d.id, visible: d.data().visible!==false, reward: d.data().reward||'', ...d.data()}));
        const visibleItems = items.filter(i=> i.visible!==false);
        milestoneLegend.textContent = visibleItems.length ? `Hodnosti: ${visibleItems.map(i=>i.threshold+ ' ‚Äì '+ i.label).join(' ‚Ä¢ ')}` : 'Hodnosti zat√≠m nejsou nastaven√©';

        // Public list in modal (visible only)
        visibleItems.forEach(m=>{
          const c = document.createElement('div'); c.className='card';
          c.innerHTML = `<div class="row" style="justify-content:space-between"><div><b>${m.threshold}</b> bod≈Ø ‚Äì ${m.label}${m.reward? ` <span class="pill" title=\"V√Ωhra\">${m.reward}</span>`:''}</div></div>`;
          milestonesPublicList.appendChild(c);
        });

        // Manager edit list
        items.forEach(m=>{
          const row = document.createElement('div'); row.className='card';
          row.innerHTML = `
            <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap">
              <input class="input" data-ms-th="${m.id}" type="number" value="${m.threshold}" style="max-width:120px"/>
              <input class="input" data-ms-lb="${m.id}" value="${m.label||''}" style="flex:1; min-width:180px"/>
              <input class="input" data-ms-rw="${m.id}" value="${m.reward||''}" placeholder="V√Ωhra" style="flex:1; min-width:180px"/>
              <label class="row" style="gap:6px"><input type="checkbox" data-ms-vs="${m.id}" ${m.visible!==false?'checked':''}/> Viditeln√©</label>
              <button class="btn small ghost" data-ms-save="${m.id}">Ulo≈æit</button>
              <button class="btn small ghost" data-del="${m.id}">Smazat</button>
            </div>`;
          milestonesList.appendChild(row);
          row.querySelector(`[data-del="${m.id}"]`)?.addEventListener('click', async()=>{
            if(confirm('Smazat miln√≠k?')) await deleteDoc(doc(db,'milestones', m.id));
          });
          row.querySelector(`[data-ms-save="${m.id}"]`)?.addEventListener('click', async()=>{
            const th = Number(row.querySelector(`[data-ms-th="${m.id}"]`).value);
            const lb = row.querySelector(`[data-ms-lb="${m.id}"]`).value.trim();
            const rw = row.querySelector(`[data-ms-rw="${m.id}"]`).value.trim();
            const vs = !!row.querySelector(`[data-ms-vs="${m.id}"]`).checked;
            if(!Number.isFinite(th)) return alert('Zadejte platn√Ω pr√°h.');
            try{ await updateDoc(doc(db,'milestones', m.id), { threshold: th, label: lb, reward: rw, visible: vs }); }
            catch(e){ alert('Ulo≈æen√≠ selhalo: '+(e?.message||e)); }
          });
        });
      });
    }

    addMilestone?.addEventListener('click', async()=>{
      if(!msThreshold.value || !msLabel.value) return alert('Dopl≈àte hodnotu a popisek.');
      try{
        await addDoc(collection(db,'milestones'), { threshold: Number(msThreshold.value), label: msLabel.value.trim(), reward: (msReward.value||'').trim(), visible: !!msVisible.checked, createdAt: serverTimestamp() });
        msThreshold.value=''; msLabel.value=''; msReward.value=''; msVisible.checked=true;
      }catch(e){ alert('Chyba p≈ôid√°n√≠: '+(e?.message||e)); }
    });

    // === Roles / Operators (manager) ===
    async function buildUsersForManager(){
      if(currentRole!=="manager") return;
      const opsSnap = await getDocs(query(collection(db,'operators'), orderBy('email')));
      userSelect.innerHTML = ''; rolesList.innerHTML='';
      const opMap = {}; 
      opsSnap.forEach(d=>{
        const u = {id:d.id, ...d.data()};
        opMap[u.id] = u;
        const opt = document.createElement('option'); opt.value = u.id; opt.textContent = `${u.email}${u.displayName? ' ('+u.displayName+')':''}`;
        userSelect.appendChild(opt);
      });
      // Pre-fill displayName for selected
      userSelect.addEventListener('change', async()=>{
        const uid = userSelect.value; if(!uid){ displayNameInput.value=''; return; }
        const s = await getDoc(doc(db,'operators', uid));
        displayNameInput.value = s.exists()? (s.data().displayName||'') : '';
      });
      // Render current roles (show email instead of uid)
      const roleDocs = await getDocs(collection(db,'roles'));
      roleDocs.forEach(d=>{
        const r = {id:d.id, ...d.data()};
        const email = opMap[r.id]?.email || r.id;
        const disp = opMap[r.id]?.displayName ? ` (${opMap[r.id].displayName})` : '';
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<div class="row" style="justify-content:space-between">
          <div><b>${email}</b>${disp} ‚Üí ${ROLE_LABELS[r.role]||r.role}</div>
          <button class="btn small ghost" data-remove="${r.id}">Odebrat</button>
        </div>`;
        rolesList.appendChild(card);
        card.querySelector('[data-remove]')?.addEventListener('click', async()=>{
          if(confirm('Odebrat roli?')) await deleteDoc(doc(db,'roles', r.id));
          buildUsersForManager();
        });
      });
    }
    assignRole?.addEventListener('click', async()=>{
      try{
        const uid = userSelect.value; if(!uid) return alert('Vyberte u≈æivatele.');
        const dn = (displayNameInput.value||'').trim();
        if(dn){ await updateDoc(doc(db,'operators', uid), { displayName: dn }); }
        await setDoc(doc(db,'roles', uid), { role: roleSelect.value, updatedAt: serverTimestamp() });
        alert('Ulo≈æeno.');
        buildUsersForManager();
        refreshLeaderboard();
      }catch(e){ alert('Chyba: '+(e?.message||e)); }
    });

    // === Settings: Weekly info ===
    async function ensureSettingsDocExists(){
      const ref = doc(db,'settings','current_week_info');
      const s = await getDoc(ref);
      if(!s.exists()) await setDoc(ref, { text: '', createdAt: serverTimestamp() });
    }
    async function subscribeWeekInfo(){
      const ref = doc(db,'settings','current_week_info');
      unsubscribeSettings = onSnapshot(ref, (snap)=>{
        const data = snap.exists()? snap.data(): {text:''};
        weekInfoTextView.innerHTML = renderWeekInfoText(data.text||'');
        if(currentRole==='manager') weeklyInfoManager.value = data.text||'';
      }, (err)=>{
        console.error('settings onSnapshot error', err);
      });
    }
    saveWeekInfo?.addEventListener('click', async()=>{
      try{
        await setDoc(doc(db,'settings','current_week_info'), { text: weeklyInfoManager.value.trim(), updatedAt: serverTimestamp() });
        alert('Popis t√Ωdne ulo≈æen');
      }catch(e){ alert('Chyba ulo≈æen√≠: '+(e?.message||e)); }
    });

    // Map button ‚Äì open image page from settings/map.image_url (optional)
    mapBtn?.addEventListener('click', async()=>{
      const w = window.open('', '_blank');
      try{
        const mapDoc = await getDoc(doc(db,'settings','map'));
        const url = (mapDoc.exists()? mapDoc.data().image_url: '') || '';
        const html = `<!doctype html><html lang="cs"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Mapa</title></head><body style="margin:0; display:grid; place-items:center; min-height:100vh; font-family:system-ui,sans-serif; background:#0c1222; color:#e7f0ff"><div id="wrap" style="text-align:center; padding:20px">${url? `<img src="${url}" alt="Mapa" style="max-width:100%; height:auto;" onerror="this.replaceWith(document.createTextNode('Obr√°zek mapy nen√≠ dostupn√Ω.'))">` : 'Obr√°zek mapy zat√≠m nen√≠ nastaven.'}<div style="margin-top:12px; opacity:.7">Toto okno lze zav≈ô√≠t.</div></div></body></html>`;
        w.document.write(html);
        w.document.close();
      }catch(e){
        w.document.write('<p style="font-family:system-ui">Mapa nen√≠ k dispozici.</p>');
        w.document.close();
      }
    });

    // Milestones button ‚Äì toggle modal with visible milestones
    milestonesBtn?.addEventListener('click', ()=>{
      milestonesModal.classList.toggle('hidden');
    });
    closeMilestonesModal?.addEventListener('click', ()=> milestonesModal.classList.add('hidden'));

    // Avatar modal
    avatarBtn?.addEventListener('click', ()=>{
      if(!currentUser){ alert('Nejprve se p≈ôihlaste.'); return; }
      buildAvatarGrid();
      avatarModal.classList.remove('hidden');
    });
    closeAvatarModal?.addEventListener('click', ()=> avatarModal.classList.add('hidden'));

    // === Populate target operator select (for managers) ===
    async function populateTargetOperatorSelect(){
      try{
        if(currentRole!=='manager'){ targetOperator.classList.add('hidden'); return; }
        const opsSnap = await getDocs(query(collection(db,'operators'), orderBy('email')));
        targetOperator.innerHTML = '';
        const first = document.createElement('option'); first.value=''; first.textContent='‚Äì Vyberte oper√°tora ‚Äì'; targetOperator.appendChild(first);
        opsSnap.forEach(d=>{
          const u = {id:d.id, ...d.data()};
          const opt = document.createElement('option'); opt.value = u.id; opt.textContent = `${u.email}${u.displayName? ' ('+u.displayName+')':''}`;
          targetOperator.appendChild(opt);
        });
        targetOperator.classList.remove('hidden');
      }catch(e){ console.warn('populateTargetOperatorSelect failed', e); }
    }

    // === Operator add/remove points + audit ===
    addPointsBtn?.addEventListener('click', async()=>{
      try{
        if(!currentUser) return alert('Nejprve se p≈ôihlaste.');
        const actId = activitySelect.value; if(!actId) return alert('Vyberte aktivitu.');
        const aSnap = await getDoc(doc(db,'activities', actId));
        if(!aSnap.exists()) return alert('Aktivita neexistuje.');
        const a = aSnap.data();
        const custom = Number(customDelta.value);
        const delta = Number.isFinite(custom) && custom !== 0 ? custom : Number(a.points||0);
        if(!Number.isFinite(delta) || delta===0) return alert('Zadejte platn√Ω poƒçet bod≈Ø (nenulov√Ω).');

        // Determine target user (manager may award to others)
        const targetUid = currentRole==='manager' ? (targetOperator.value||'') : currentUser.uid;
        if(currentRole==='manager' && !targetUid) return alert('Vyberte, kter√©mu oper√°torovi chcete body p≈ôidat/odebrat.');

        // Load target profile for audit metadata
        let targetProfile = null;
        try{ const tSnap = await getDoc(doc(db,'operators', targetUid)); targetProfile = tSnap.exists()? {id:tSnap.id, ...tSnap.data()} : null; }catch{ }

        const logEntry = {
          uid: targetUid,
          activityId: actId,
          activityName: a.name || actId,
          category: a.category,
          delta: delta,
          createdAt: serverTimestamp()
        };
        await addDoc(collection(db,'logs'), logEntry);

        // Audit: record actor (who did it) and target (who received points)
        const auditEntry = {
          actorUid: currentUser.uid,
          actorEmail: currentUser.email,
          actorName: currentOperatorProfile?.displayName || currentUser.displayName || currentUser.email,
          targetUid: targetUid,
          targetEmail: targetProfile?.email || 'unknown',
          targetName: targetProfile?.displayName || targetProfile?.email || targetUid,
          activityId: actId,
          activityName: a.name || actId,
          category: a.category,
          delta: delta,
          clientInfo: navigator.userAgent || 'unknown',
          createdAt: serverTimestamp()
        };
        await addDoc(collection(db,'audits'), auditEntry);

        customDelta.value='';
        await Promise.all([
          loadMyRecent(),
          refreshLeaderboard(),
          (currentRole==='manager'? loadAudits(): Promise.resolve())
        ]);
      }catch(err){
        console.error('addPoints error', err);
        alert('Nepoda≈ôilo se ulo≈æit z√°znam: '+(err?.message||err));
      }
    });

    // === Audits (manager only) ===
    async function loadAudits(){
      if(currentRole!=='manager'){ auditsList.innerHTML = '<div class="muted">Pouze pro vedouc√≠.</div>'; return; }
      try{
        auditsList.innerHTML = '<div class="muted">Naƒç√≠t√°m‚Ä¶</div>';
        let snap;
        try{
          snap = await getDocs(query(collection(db,'audits'), orderBy('createdAt','desc'), limit(100)));
        }catch(e){
          // Fallback bez indexu
          const s2 = await getDocs(collection(db,'audits'));
          const arr=[]; s2.forEach(d=>arr.push({id:d.id, ...d.data()}));
          arr.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
          renderAudits(arr);
          return;
        }
        const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
        renderAudits(arr);
      }catch(err){
        console.error('loadAudits error', err);
        auditsList.innerHTML = `<div class="muted">${err?.message||err}</div>`;
      }
    }

    function renderAudits(items){
      auditsList.innerHTML = '';
      if(!items.length){ auditsList.innerHTML = '<div class="muted">≈Ω√°dn√© z√°znamy.</div>'; return; }
      items.forEach(a=>{
        const dt = a.createdAt?.seconds ? new Date(a.createdAt.seconds*1000) : new Date();
        const card = document.createElement('div'); card.className='card';
        const sign = (Number(a.delta)>=0? '+':'' )+ Number(a.delta);
        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div>
              <div><b>${a.actorName||a.actorEmail}</b> <span class="muted">udƒõlil/a</span> <b>${a.targetName||a.targetEmail}</b></div>
              <div class="muted">${dt.toLocaleString()} ‚Ä¢ ${a.activityName||a.activityId} ‚Ä¢ ${a.category}</div>
            </div>
            <div class="row">
              <div style="margin-right:8px"><b>${sign}</b> b.</div>
              <button class="btn small ghost" data-del-audit="${a.id}">Smazat</button>
            </div>
          </div>`;
        const delBtn = card.querySelector('[data-del-audit]');
        delBtn?.addEventListener('click', async()=>{
          if(confirm('Smazat tento auditn√≠ z√°znam?')){
            try{ await deleteDoc(doc(db,'audits', a.id)); delBtn.closest('.card')?.remove(); }
            catch(e){ alert('Smaz√°n√≠ selhalo: '+(e?.message||e)); }
          }
        });
        auditsList.appendChild(card);
      });
    }
    refreshAudits?.addEventListener('click', ()=> loadAudits());

    // Leaderboard = sum of logs per operator (client-side aggregation)
    async function refreshLeaderboard(){
      const [opsSnap, msSnap, rolesSnap] = await Promise.all([
        getDocs(collection(db,'operators')),
        getDocs(query(collection(db,'milestones'), orderBy('threshold'))),
        getDocs(collection(db,'roles'))
      ]);
      const milestones = []; msSnap.forEach(d=> milestones.push(d.data()));
      const roleMap = {}; rolesSnap.forEach(r=>{ const x=r.data(); roleMap[r.id]=x.role; });

      const ops = [];
      opsSnap.forEach(d=>{
        const u = {id:d.id, ...d.data()};
        const role = roleMap[u.id];
        if(OPERATOR_ROLES.has(role)) ops.push(u);
      });

      const sums = {};
      const logsSnap = await getDocs(collection(db,'logs'));
      logsSnap.forEach(d=>{ const l=d.data(); sums[l.uid]=(sums[l.uid]||0)+Number(l.delta||0)});

      const items = ops.map(o=>({ uid:o.id, name:o.displayName||o.email||o.id, total:sums[o.id]||0, avatarUrl:o.avatarUrl||null, avatarColor:o.avatarColor||null }));
      items.sort((a,b)=> b.total - a.total);
      const maxTotal = Math.max(1, ...items.map(i=>i.total));
      const medals = ['ü•á','ü•à','ü•â'];

      leaderboard.innerHTML = '';
      items.forEach((it,idx)=>{
        const card = document.createElement('div'); card.className='card';
        const achieved = milestones.filter(m=> it.total >= m.threshold && (m.visible!==false)).slice(-1)[0] || null;
        const achievedLabel = achieved ? achieved.label : null;
        const pct = Math.max(0, Math.min(100, Math.round((it.total/maxTotal)*100)));

        const nameHtml = `${it.name} ${achievedLabel? `<span class=\"pill\" title=\"Dosa≈æen√° hodnost\">${achievedLabel}</span>`:''}`;

        card.innerHTML = `
          <div class="leaderboard-item">
            <div class="medal-big">${idx<3? medals[idx]: ''}</div>
            <div class="avatar" data-uid="${it.uid}">${it.avatarUrl? `<img src='${it.avatarUrl}' alt='avatar' onerror="this.closest('.avatar').textContent='${(it.name||'--').substring(0,2).toUpperCase()}';">` : (it.name||'--').substring(0,2).toUpperCase()}</div>
            <div>
              <div class="row" style="justify-content:space-between">
                <div><b>${nameHtml}</b></div>
                <div><b>${it.total}</b> b.</div>
              </div>
              <div class="progress" title="Postup v≈Øƒçi l√≠drovi">
                <div class="bar" style="width:${pct}%"></div>
              </div>
            </div>
            <div>#${idx+1}</div>
          </div>`;
        const av = card.querySelector('.avatar');
        if(!it.avatarUrl){
          // apply stable gradient color based on stored or generated color
          const color = it.avatarColor || generateAndPersistAvatarColor(it.uid);
          av.style.background = `linear-gradient(135deg, ${color}, rgba(255,255,255,0.85))`;
        }
        leaderboard.appendChild(card);
      });
    }

    // Recent logs for current user
    async function loadMyRecent(){
      if(!currentUser){ myRecent.innerHTML=''; return; }
      myRecent.innerHTML = '';
      try{
        const ql = query(collection(db,'logs'), where('uid','==', currentUser.uid), orderBy('createdAt','desc'), limit(10));
        const snap = await getDocs(ql);
        const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
        if(!arr.length){ myRecent.innerHTML = '<div class="muted">Zat√≠m ≈æ√°dn√© z√°znamy.</div>'; return; }
        arr.forEach(l=>{
          const dt = l.createdAt?.seconds ? new Date(l.createdAt.seconds*1000) : new Date();
          const card = document.createElement('div'); card.className='card';
          const sign = (Number(l.delta)>=0? '+':'' )+ Number(l.delta);
          card.innerHTML = `<div class="row" style="justify-content:space-between"><div>${l.activityName||l.activityId}</div><div><b>${sign}</b> b. ‚Ä¢ <span class=\"muted\">${dt.toLocaleString()}</span></div></div>`;
          myRecent.appendChild(card);
        });
      }catch(e){
        myRecent.innerHTML = '<div class="muted">Nepoda≈ôilo se naƒç√≠st z√°znamy.</div>';
      }
    }

    // === Snow effect (simple canvas particles) ===
    const snowCanvas = document.getElementById('snow');
    const cx = snowCanvas.getContext('2d');
    let W,H; function resize(){ W = snowCanvas.width = window.innerWidth; H = snowCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    const flakes = Array.from({length: 140}, ()=>({ x: Math.random()*W, y: Math.random()*H, r: Math.random()*2+1, s: Math.random()*0.6+0.2, w: Math.random()*1.2+0.2 }));
    function tick(){ cx.clearRect(0,0,W,H); cx.globalAlpha=0.9; flakes.forEach(f=>{ cx.beginPath(); cx.arc(f.x, f.y, f.r, 0, Math.PI*2); cx.fillStyle='#fff'; cx.fill(); f.y += f.s; f.x += Math.sin(f.y*0.01)*f.w; if(f.y>H+5){ f.y=-5; f.x=Math.random()*W; } }); requestAnimationFrame(tick); }
    tick();

    // === Tiny self-tests (console) ===
    function runSelfTests(){
      const tests = [];
      // includeActivityThisWeek tests
      const now = new Date();
      const yesterday = new Date(now.getTime()-86400000); const tomorrow = new Date(now.getTime()+86400000);
      tests.push({test:'include tel_weekly in range', pass: includeActivityThisWeek({enabled:true,category:'tel_weekly',weekStart:yesterday,weekEnd:tomorrow}, 'operator_tel', now)});
      tests.push({test:'exclude tel_weekly out of range', pass: !includeActivityThisWeek({enabled:true,category:'tel_weekly',weekStart:yesterday,weekEnd:yesterday}, 'operator_tel', now)});
      tests.push({test:'include kore_static always for kore role', pass: includeActivityThisWeek({enabled:true,category:'kore_static'}, 'operator_kore', now)});
      tests.push({test:'exclude disallowed category by role', pass: !includeActivityThisWeek({enabled:true,category:'kore_static'}, 'operator_tel', now)});

      // progress bar sanity: leader 100, someone 50 => 50%
      const max=100, someone=50; const pct=Math.round((someone/Math.max(1,max))*100); tests.push({test:'progress 50/100 = 50%', pass:pct===50});

      // renderWeekInfoText tests
      const html1 = renderWeekInfoText('A\nB');
      tests.push({test:'newline to <br>', pass: html1.includes('<p>A<br>B</p>')});
      const html2 = renderWeekInfoText('A\n\nB');
      tests.push({test:'double newline to two <p>', pass: html2.includes('<p>A</p>') && html2.includes('<p>B</p>')});
      const html3 = renderWeekInfoText('**A** *B* __C__');
      tests.push({test:'formatting bold/italic/underline', pass: html3.includes('<b>A</b>') && html3.includes('<i>B</i>') && html3.includes('<u>C</u>')});

      console.table(tests);
    }
    runSelfTests();
      // === Avatar helpers ===
    function hashToColor(str){
      let h=0; for(let i=0;i<str.length;i++){ h = (h<<5)-h + str.charCodeAt(i); h|=0; }
      // Map hash to HSL (pastel-ish)
      const hue = Math.abs(h)%360; const sat=70; const light=60;
      return `hsl(${hue} ${sat}% ${light}%)`;
    }
    function generateAndPersistAvatarColor(uid){
      const c = hashToColor(uid||Math.random().toString());
      // fire and forget, best-effort; only if current user or manager can set
      if(currentUser && (currentUser.uid===uid || currentRole==='manager')){
        updateDoc(doc(db,'operators', uid), { avatarColor: c }).catch(()=>{});
      }
      return c;
    }

    async function buildAvatarGrid(){
      avatarGrid.innerHTML='';
      // Try load settings for avatars
      let base = '', count=10;
      try{
        const s = await getDoc(doc(db,'settings','avatars'));
        if(s.exists()){ base = s.data().base_url||''; count = Number(s.data().count)||10; }
      }catch{}
      // Fallback: attempt to build list even if base missing (will show not available)
      const items = [];
      for(let i=1;i<=count;i++){
        const nn = String(i).padStart(2,'0');
        const url = base? `${base.replace(/\/$/,'')}/avatar_${nn}.png` : '';
        items.push({i, url});
      }
      items.forEach(it=>{
        const btn = document.createElement('button'); btn.className='btn ghost'; btn.style.padding='0'; btn.style.borderRadius='12px'; btn.title = `avatar_${String(it.i).padStart(2,'0')}.png`;
        btn.innerHTML = `<div style="width:80px; height:80px; overflow:hidden; border-radius:12px; background:rgba(255,255,255,.06); display:grid; place-items:center">
          ${it.url? `<img src="${it.url}" alt="avatar" style="width:100%; height:100%; object-fit:cover" onerror="this.replaceWith(document.createTextNode('N¬†A'))">` : 'N¬†A'}
        </div>`;
        btn.addEventListener('click', async()=>{
          if(!currentUser) return alert('Nejprve se p≈ôihlaste.');
          try{
            await updateDoc(doc(db,'operators', currentUser.uid), { avatarUrl: it.url || null });
            avatarModal.classList.add('hidden');
            refreshLeaderboard();
          }catch(e){ alert('Ulo≈æen√≠ avatara selhalo: '+(e?.message||e)); }
        });
        avatarGrid.appendChild(btn);
      });
      // Extra mo≈ænost: odebrat avatar
      const noneBtn = document.createElement('button'); noneBtn.className='btn small'; noneBtn.textContent='≈Ω√°dn√Ω avatar (pou≈æ√≠t inici√°ly)';
      noneBtn.addEventListener('click', async()=>{
        try{ await updateDoc(doc(db,'operators', currentUser.uid), { avatarUrl: null }); avatarModal.classList.add('hidden'); refreshLeaderboard(); }
        catch(e){ alert('Ulo≈æen√≠ selhalo: '+(e?.message||e)); }
      });
      avatarGrid.appendChild(noneBtn);
    }
</script>

  <!-- =============================
       FIREBASE FIRESTORE SECURITY RULES (kop√≠rujte **jen** blok n√≠≈æe do konzole Firebase)
       ============================= -->
  <!--
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function userId() { return request.auth.uid; }
    function userRole(u) {
      return get(/databases/$(database)/documents/roles/$(u)).data.role;
    }
    function isManager() { return userRole(userId()) == 'manager'; }

    function allowedCategoriesFor(role) {
      return role == 'manager' ? ['tel_weekly','kore_static']
           : role == 'operator_tel' ? ['tel_weekly']
           : role == 'operator_kore' ? ['kore_static']
           : role == 'operator_tel_kore' ? ['tel_weekly','kore_static']
           : [];
    }
    function categoryAllowedForCurrentUser(category) {
      return category in allowedCategoriesFor(userRole(userId()));
    }
    function activityCategory(actId) {
      return get(/databases/$(database)/documents/activities/$(actId)).data.category;
    }
    function activityWithinWeek(actId) {
      return get(/databases/$(database)/documents/activities/$(actId)).data.weekStart != null &&
             get(/databases/$(database)/documents/activities/$(actId)).data.weekEnd != null &&
             request.time >= get(/databases/$(database)/documents/activities/$(actId)).data.weekStart &&
             request.time <= get(/databases/$(database)/documents/activities/$(actId)).data.weekEnd;
    }

    // Roles
    match /roles/{uid} {
      allow read: if isSignedIn() && (uid == userId() || isManager());
      allow write: if isSignedIn() && isManager();
    }

    // Operators profiles
    match /operators/{uid} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && uid == userId();
      allow update: if isSignedIn() && (uid == userId() || isManager());
      allow delete: if isSignedIn() && isManager();
    }

    // Activities (managed by managers)
    match /activities/{id} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isManager();
    }

    // Milestones (managed by managers)
    match /milestones/{id} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isManager();
    }

    // Settings (weekly info text)
    match /settings/{doc} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isManager();
    }

    // Logs ‚Äì operators create entries only for sebe; manager m≈Ø≈æe vytvo≈ôit i za kohokoli
    match /logs/{logId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && exists(/databases/$(database)/documents/activities/$(request.resource.data.activityId))
        && categoryAllowedForCurrentUser(activityCategory(request.resource.data.activityId))
        && (
             request.resource.data.uid == userId() /* operator s√°m za sebe */
             || isManager() /* manager m≈Ø≈æe za kohokoli */
           )
        && (activityCategory(request.resource.data.activityId) != 'tel_weekly' || activityWithinWeek(request.resource.data.activityId))
        && request.resource.data.keys().hasOnly(['uid','activityId','activityName','category','delta','createdAt'])
        && (request.resource.data.delta is int || request.resource.data.delta is float);

      allow update: if isSignedIn() && isManager();
      allow delete: if isSignedIn() && isManager();
    }

    // Audits ‚Äì only managers can read; create allowed for any signed-in (audit obsahuje actor/target); managers can delete
    match /audits/{id} {
      allow read: if isSignedIn() && isManager();
      allow create: if isSignedIn();
      allow delete: if isSignedIn() && isManager();
      allow update: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
-->

</body>
</html>
