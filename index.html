<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Přihlášení • Vánoční výzva 2025</title>
  <link rel="stylesheet" href="./assets/css/styles.css" />
</head>
<body>
  <main class="card" style="max-width:560px; margin:6vh auto">
    <h2>Přihlášení</h2>
    <p class="muted">Použijte firemní e-mail; první přihlášení vytvoří profil.</p>
    <form id="authForm" class="stack">
      <label for="email">E-mail</label>
      <input id="email" class="input" type="email" required placeholder="jan.novak@homecredit.cz" />
      <label for="password">Heslo</label>
      <input id="password" class="input" type="password" required placeholder="••••••••" />
      <div class="row">
        <button class="btn" type="submit">Přihlásit / Registrovat</button>
        <button class="btn secondary" id="resetPass" type="button">Reset hesla</button>
      </div>
    </form>
  </main>

  <script type="module">
    import { initTheme, initChrome } from './assets/js/ui.js';
    import { auth, db } from './assets/js/firebase.js';
    import { signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    initTheme(); initChrome();

    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    document.getElementById('resetPass').addEventListener('click', async()=>{
      const email = emailEl.value.trim(); if(!email) return alert('Zadejte e-mail.');
      await sendPasswordResetEmail(auth, email); alert('Odeslán reset hesla.');
    });

    document.getElementById('authForm').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const email = emailEl.value.trim(); const pass = passEl.value.trim();
      try {
        try { await signInWithEmailAndPassword(auth, email, pass); }
        catch { await createUserWithEmailAndPassword(auth, email, pass); }
      } catch(err){ alert('Chyba: '+(err?.message||err)); }
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;
      // zajistit profil v operators/{uid}
      const opRef = doc(db,'operators', user.uid);
      const snap = await getDoc(opRef);
      if(!snap.exists()){
        await setDoc(opRef, {
          uid: user.uid, email: user.email,
          displayName: user.displayName || user.email.split('@')[0],
          createdAt: serverTimestamp()
        });
      }
      location.href = './dashboard.html';
    });
  </script>
</body>
</html>
