<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Santa App Challenge ‚Äì Cesta k v√°noƒçn√≠ kometƒõ (offline)</title>
  <meta name="description" content="Offline HTML aplikace pro v√°noƒçn√≠ soutƒõ≈æ oper√°tor≈Ø: podpora mobiln√≠ aplikace, prodeje a efektivity." />
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827cc;     /* gray-900 with alpha */
      --soft:#1f2937;        /* gray-800 */
      --muted:#94a3b8;       /* slate-400 */
      --text:#e5e7eb;        /* gray-200 */
      --brand:#22d3ee;       /* cyan-400 */
      --brand-2:#10b981;     /* emerald-500 */
      --accent:#f59e0b;      /* amber-500 */
      --danger:#ef4444;      /* red-500 */
      --success:#34d399;     /* green-400 */
      --card:#0b1226;        /* custom */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif; 
      background: radial-gradient(1200px 800px at 10% -10%, #1b2a52 0%, transparent 60%),
                  radial-gradient(900px 700px at 110% 10%, #16304f 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(1.2) blur(8px);
      background:linear-gradient(180deg, #0b1226cc, #0b122680);
      border-bottom:1px solid #1f2a44;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}
    .title{
      display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.4px;
    }
    .title .logo{font-size:28px}
    .subtitle{color:var(--muted); font-size:14px}

    /* Tabs */
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .tab{padding:10px 14px; border-radius:12px; background:#0d1731; color:#cbd5e1; cursor:pointer; border:1px solid transparent; user-select:none}
    .tab.active{background:linear-gradient(180deg,#102046,#0e1a37); border-color:#20325c; color:white; box-shadow:0 0 0 1px #0d1b36 inset, 0 10px 30px -20px #22d3ee}
    .grid{display:grid; gap:16px}
    @media(min-width:900px){.grid.cols-2{grid-template-columns:1fr 1fr}}
    @media(min-width:1200px){.grid.cols-3{grid-template-columns:2fr 1fr 1fr}}

    .card{
      background:linear-gradient(180deg,#0e1833,#0b1226); border:1px solid #1c2a4b; border-radius:16px; padding:16px;
      box-shadow:0 10px 30px -22px #000 inset, 0 12px 40px -28px #000;
    }
    .card h3{margin:0 0 8px 0; font-size:16px}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    input,select,button,textarea{
      background:#0a1329; color:#e2e8f0; border:1px solid #1f2e54; padding:10px 12px; border-radius:12px; font:inherit
    }
    input::placeholder, textarea::placeholder{color:#64748b}
    button{cursor:pointer}
    .btn{background:linear-gradient(180deg,#0f2349,#0c1a35); border-color:#1f2e54}
    .btn-primary{background:linear-gradient(180deg,#0f2b51,#0d2346); border-color:#2b436f}
    .btn-cta{background:linear-gradient(180deg,#0e3b39,#0a2d2b); border-color:#1d6b61}
    .btn-danger{background:linear-gradient(180deg,#451515,#2a0f0f); border-color:#6b1f1f}
    .btn-accent{background:linear-gradient(180deg,#3c2a08,#2a1c05); border-color:#5a3c10}

    .kpi{display:flex; gap:12px; align-items:baseline; padding:12px 0}
    .kpi .v{font-size:28px; font-weight:800}
    .kpi .l{color:var(--muted)}

    .leaderboard table{width:100%; border-collapse:collapse}
    .leaderboard th,.leaderboard td{padding:10px; border-bottom:1px dashed #223357; text-align:left}
    .leaderboard tr:hover{background:#0b1735}

    .progress{height:14px; background:#0a142f; border:1px solid #1b2b56; border-radius:999px; overflow:hidden}
    .progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--brand-2));}

    .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#0a1d18; border:1px solid #1d6b61; color:#c7f9ec; font-size:12px}
    .pill{display:inline-flex; padding:2px 8px; border-radius:999px; background:#0e1730; border:1px solid #20325c; color:#e2e8f0; font-size:12px}

    .footer{color:#64748b; font-size:12px; text-align:center; padding:24px}

    .snow{position:fixed; inset:0; pointer-events:none; z-index:0}
    .content{position:relative; z-index:1}

    .mini{font-size:12px; color:var(--muted)}

    details summary{cursor:pointer}
  </style>
</head>
<body>
  <canvas class="snow" id="snow"></canvas>
  <header>
    <div class="wrap">
      <div class="title">
        <div class="logo">üéÖ‚ú®</div>
        <div>
          <div>Santa App Challenge ‚Äî <span class="pill">Cesta k v√°noƒçn√≠ kometƒõ</span></div>
          <div class="subtitle">Gamifikovan√° soutƒõ≈æ pro oper√°tory: podpora mobiln√≠ aplikace, prodeje a efektivity.</div>
        </div>
      </div>
      <nav class="tabs" id="tabs"></nav>
    </div>
  </header>

  <!-- ‚úÖ Firebase p≈ôihl√°≈°en√≠ panel (zobrazuje se naho≈ôe vpravo) -->
  <div id="authBox" class="card" style="position:fixed; right:16px; top:76px; z-index:1000; max-width:340px; display:block">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px">
      <div id="authState" class="mini">Nep≈ôihl√°≈°en</div>
      <div class="row" style="gap:6px">
        <button type="button" id="logoutBtn" class="btn" style="display:none">Odhl√°sit</button>
      </div>
    </div>
    <form id="loginForm" class="row">
      <input type="email" name="email" placeholder="email" required>
      <input type="password" name="password" placeholder="heslo" required>
      <button type="submit" class="btn-cta">P≈ôihl√°sit</button>
    </form>
    <div class="mini" style="margin-top:6px">Tip: Pokud jste p≈ôihl√°≈°eni, body se ukl√°daj√≠ do Firestore a uvid√≠ je cel√Ω t√Ωm.</div>
  </div>


  <main class="wrap content" id="app"></main>

  <div class="footer">¬© 2025 ‚Äì Intern√≠ soutƒõ≈æn√≠ n√°stroj. Data se ukl√°daj√≠ pouze lok√°lnƒõ do va≈°eho prohl√≠≈æeƒçe.</div>

<script>
/********************
 * Jednoduch√Ω stav + ulo≈æen√≠
 ********************/
const STORAGE_KEY = 'santa_app_challenge_v1';
const todayISO = () => new Date().toISOString().slice(0,10);
const defaultConfig = {
  contest:{
    name:"Santa App Challenge",
    start:"2025-11-15",
    end:"2025-12-22",
    milestones:[
      {points:50,  label:"üéÅ Pern√≠kov√© mƒõsteƒçko"},
      {points:120, label:"üõ∑ Sob√≠ pr≈Øsmyk"},
      {points:220, label:"üè† V√°noƒçn√≠ vesnice"},
      {points:350, label:"üåü Zlat√° kometa"}
    ]
  },
  activities:[
    {id:'app_activation', name:'Aktivace mobiln√≠ aplikace', points:10, category:'Appka'},
    {id:'product_small', name:'Prodej dopl≈àkov√© slu≈æby', points:15, category:'Prodej'},
    {id:'product_big', name:'Uzav≈ôen√Ω produkt (√∫vƒõr/karta)', points:25, category:'Prodej'},
    {id:'sales_over', name:'P≈ôekroƒçen√≠ c√≠le o 10 % (t√Ωden)', points:20, category:'Prodej', bonus:true},
    {id:'efficiency_kpi', name:'Dodr≈æen√≠ KPI (AHT/SLA)', points:5, category:'Efektivita'},
    {id:'csat', name:'Pozitivn√≠ hodnocen√≠ z√°kazn√≠ka', points:10, category:'Kvalita'},
    {id:'creative', name:'Kreativn√≠ n√°pad / mini video', points:20, category:'Kreativa'}
  ],
  operators:[],
  logs:[], // {id, date, operatorId, activityId, points, note}
};

let state = load() || defaultConfig;

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function load(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null }
}
function resetAll(){
  if(confirm('Opravdu smazat v≈°echna lok√°ln√≠ data?')){
    localStorage.removeItem(STORAGE_KEY);
    state = JSON.parse(JSON.stringify(defaultConfig));
    render();
  }
}

/********************
 * Pomocn√© funkce
 ********************/
const by = f => (a,b)=> f(a)>f(b)?1:f(a)<f(b)?-1:0;
const sum = arr => arr.reduce((a,b)=>a+b,0);
const uid = () => Math.random().toString(36).slice(2,9);
const weekKey = (dStr)=>{ const d=new Date(dStr); const oneJan = new Date(d.getFullYear(),0,1); const day = Math.floor((d-oneJan)/86400000)+oneJan.getDay(); const w = Math.ceil(day/7); return `${d.getFullYear()}-W${String(w).padStart(2,'0')}`};
const inRange = (dStr, start, end)=>{ const d=new Date(dStr); return (!start||d>=new Date(start)) && (!end||d<=new Date(end)); };

/********************
 * UI Skeleton
 ********************/
const TABS = [
  {id:'dashboard', label:'üìä P≈ôehled'},
  {id:'log', label:'üìù Z√°znamy'},
  {id:'operators', label:'üë• Oper√°to≈ôi'},
  {id:'settings', label:'‚öôÔ∏è Nastaven√≠'},
  {id:'backup', label:'üíæ Export/Import'}
];
let currentTab = 'dashboard';

function renderTabs(){
  const el = document.getElementById('tabs');
  el.innerHTML = '';
  TABS.forEach(t=>{
    const b = document.createElement('button');
    b.className = 'tab'+(t.id===currentTab?' active':'');
    b.textContent = t.label;
    b.onclick = ()=>{ currentTab=t.id; render(); };
    el.appendChild(b);
  })
}

function setMain(html){
  const app = document.getElementById('app');
  app.innerHTML = html;
}

/********************
 * DASHBOARD
 ********************/
function viewDashboard(){
  const {start,end,milestones} = state.contest;
  const totalsByOp = scoreByOperator();
  const totalPoints = sum(Object.values(totalsByOp));
  const totalLogs = state.logs.length;
  const appActivations = state.logs.filter(l=>l.activityId==='app_activation').length;

  const top3 = Object.entries(totalsByOp)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,5)
    .map(([opId,pts],i)=>{
      const op = state.operators.find(o=>o.id===opId) || {name:'(nezn√°m√Ω)'};
      const pct = milestonePct(pts, milestones);
      return `<tr>
        <td>${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'‚≠ê'}</td>
        <td>${escapeHTML(op.name)}</td>
        <td><div class="progress"><span style="width:${pct}%"></span></div></td>
        <td style="text-align:right">${pts}</td>
      </tr>`
    }).join('');

  const weeks = groupByWeek();
  const lastWeekKey = Object.keys(weeks).sort().slice(-1)[0];
  const lastWeek = weeks[lastWeekKey]||[];
  const weekBoard = leaderboard(lastWeek);

  setMain(`
    <div class="grid cols-3">
      <section class="card">
        <h3>üéÑ Stav soutƒõ≈æe</h3>
        <div class="kpi"><div class="v">${totalPoints}</div><div class="l">Celkem bod≈Ø</div></div>
        <div class="kpi"><div class="v">${totalLogs}</div><div class="l">Z√°znam≈Ø</div></div>
        <div class="kpi"><div class="v">${appActivations}</div><div class="l">Aktivac√≠ appky</div></div>
        <div class="mini">Obdob√≠: <b>${start}</b> ‚Üí <b>${end}</b></div>
      </section>

      <section class="card leaderboard">
        <h3>üåü Celkov√© po≈ôad√≠</h3>
        <table>
          <thead><tr><th></th><th>Oper√°tor</th><th>Postup</th><th style="text-align:right">Body</th></tr></thead>
          <tbody>${top3 || ''}</tbody>
        </table>
      </section>

      <section class="card leaderboard">
        <h3>‚è±Ô∏è T√Ωdenn√≠ hvƒõzdy <span class="pill">${lastWeekKey||'‚Äî'}</span></h3>
        ${renderLeaderboardTable(weekBoard)}
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h3>üó∫Ô∏è Mapa miln√≠k≈Ø</h3>
      ${state.operators.length? state.operators.map(op=>{
        const pts = totalsByOp[op.id]||0;
        const pct = milestonePct(pts, milestones);
        const next = milestones.find(m=>pts<m.points);
        const label = next? `${pts}/${next.points} ‚Üí ${next.label}` : `${pts} ‚Äì dosa≈æeno ${milestones[milestones.length-1].label} üåü`;
        return `<div class="row" style="align-items:center; margin:10px 0">
          <div style="min-width:180px">${escapeHTML(op.name)}</div>
          <div class="progress" style="flex:1"><span style="width:${pct}%"></span></div>
          <div class="mini" style="min-width:240px; text-align:right">${label}</div>
        </div>`
      }).join('') : '<div class="mini">P≈ôidejte oper√°tory v z√°lo≈æce <b>Oper√°to≈ôi</b>.</div>'}
    </section>

    <section class="card" style="margin-top:16px">
      <h3>‚ûï Rychl√Ω z√°znam</h3>
      ${quickAddForm()}
    </section>
  `);

  // wire quick add
  wireQuickAdd();
}

function renderLeaderboardTable(board){
  return `
    <table>
      <thead><tr><th>#</th><th>Oper√°tor</th><th style="text-align:right">Body</th></tr></thead>
      <tbody>
      ${board.map((r,i)=>`<tr><td>${i<3?['ü•á','ü•à','ü•â'][i]:'‚Äî'}</td><td>${escapeHTML(r.name)}</td><td style="text-align:right">${r.points}</td></tr>`).join('')}
      </tbody>
    </table>
  `
}

function quickAddForm(){
  const opOpts = state.operators.map(o=>`<option value="${o.id}">${escapeHTML(o.name)}</option>`).join('');
  const actOpts = state.activities.map(a=>`<option value="${a.id}" data-points="${a.points}">${escapeHTML(a.name)} (+${a.points})</option>`).join('');
  return `
    <form id="quick-add" class="row">
      <select name="operatorId" required><option value="">‚Äì Oper√°tor ‚Äì</option>${opOpts}</select>
      <select name="activityId" required id="qa-activity"><option value="">‚Äì Aktivita ‚Äì</option>${actOpts}</select>
      <input name="points" id="qa-points" type="number" step="1" placeholder="Body (auto)" style="width:140px" />
      <input name="date" type="date" value="${todayISO()}" />
      <input name="note" type="text" placeholder="Pozn√°mka (voliteln√©)" style="flex:1" />
      <button class="btn-cta">P≈ôidat</button>
    </form>
  `;
}
function wireQuickAdd(){
  const f = document.getElementById('quick-add'); if(!f) return;
  const actSel = document.getElementById('qa-activity');
  const ptsInp = document.getElementById('qa-points');
  actSel.onchange = ()=>{
    const opt = actSel.options[actSel.selectedIndex];
    ptsInp.value = opt?.dataset?.points || '';
  }
  f.onsubmit = (e)=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(f).entries());
    if(!data.operatorId || !data.activityId) return;
    const pts = Number(data.points || state.activities.find(a=>a.id===data.activityId)?.points || 0);
    state.logs.push({id:uid(), date:data.date||todayISO(), operatorId:data.operatorId, activityId:data.activityId, points:pts, note:data.note||''});
    save(); render();
  }
}

/********************
 * LOGS
 ********************/
function viewLog(){
  const rows = state.logs
    .slice().sort((a,b)=> new Date(b.date)-new Date(a.date))
    .map(l=>{
      const op = state.operators.find(o=>o.id===l.operatorId)?.name||'‚Äî';
      const act = state.activities.find(a=>a.id===l.activityId)?.name||'‚Äî';
      return `<tr>
        <td>${l.date}</td>
        <td>${escapeHTML(op)}</td>
        <td>${escapeHTML(act)}</td>
        <td style="text-align:right">${l.points}</td>
        <td class="mini">${escapeHTML(l.note||'')}</td>
        <td style="text-align:right"><button class="btn btn-danger" data-del="${l.id}">Smazat</button></td>
      </tr>`
    }).join('');

  setMain(`
    <section class="card">
      <h3>üìù Z√°znamy aktivit</h3>
      <div class="row" style="margin-bottom:10px">
        <input id="filterStart" type="date" value="${state.contest.start}">
        <input id="filterEnd" type="date" value="${state.contest.end}">
        <button class="btn" id="btnFilter">Filtrovat</button>
        <button class="btn" id="btnClear">Zru≈°it filtr</button>
      </div>
      <div class="leaderboard" style="overflow:auto; max-height:60vh">
        <table>
          <thead><tr><th>Datum</th><th>Oper√°tor</th><th>Aktivita</th><th style="text-align:right">Body</th><th>Pozn.</th><th></th></tr></thead>
          <tbody id="logBody">${rows}</tbody>
        </table>
      </div>
    </section>
  `);

  document.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{ delLog(b.dataset.del); });
  document.getElementById('btnFilter').onclick = ()=>{
    const s = document.getElementById('filterStart').value;
    const e = document.getElementById('filterEnd').value;
    filterLogs(s,e);
  };
  document.getElementById('btnClear').onclick = ()=> render();
}

function filterLogs(start,end){
  const body = document.getElementById('logBody');
  body.innerHTML = state.logs.filter(l=>inRange(l.date,start,end)).sort((a,b)=>new Date(b.date)-new Date(a.date)).map(l=>{
    const op = state.operators.find(o=>o.id===l.operatorId)?.name||'‚Äî';
    const act = state.activities.find(a=>a.id===l.activityId)?.name||'‚Äî';
    return `<tr>
      <td>${l.date}</td>
      <td>${escapeHTML(op)}</td>
      <td>${escapeHTML(act)}</td>
      <td style="text-align:right">${l.points}</td>
      <td class="mini">${escapeHTML(l.note||'')}</td>
      <td style="text-align:right"><button class="btn btn-danger" data-del="${l.id}">Smazat</button></td>
    </tr>`
  }).join('');
  body.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{ delLog(b.dataset.del); });
}

function delLog(id){
  state.logs = state.logs.filter(l=>l.id!==id);
  save(); render();
}

/********************
 * OPERATORS
 ********************/
function viewOperators(){
  const list = state.operators.map(o=>{
    const pts = scoreByOperator()[o.id]||0;
    return `<tr>
      <td>${escapeHTML(o.name)}</td>
      <td class="mini">${escapeHTML(o.team||'')}</td>
      <td style="text-align:right">${pts}</td>
      <td style="text-align:right">
        <button class="btn" data-edit="${o.id}">Upravit</button>
        <button class="btn btn-danger" data-del="${o.id}">Smazat</button>
      </td>
    </tr>`
  }).join('');

  setMain(`
    <div class="grid cols-2">
      <section class="card">
        <h3>üë• Seznam oper√°tor≈Ø</h3>
        <div class="leaderboard" style="overflow:auto; max-height:60vh">
          <table>
            <thead><tr><th>Jm√©no</th><th>T√Ωm</th><th style="text-align:right">Body</th><th></th></tr></thead>
            <tbody>${list||''}</tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h3>‚ûï P≈ôidat / Upravit</h3>
        <form id="opForm" class="row">
          <input type="hidden" name="id" />
          <input name="name" placeholder="Jm√©no a p≈ô√≠jmen√≠" required style="flex:1" />
          <input name="team" placeholder="T√Ωm (voliteln√©)" />
          <button class="btn-cta" style="min-width:140px">Ulo≈æit</button>
          <button type="button" class="btn" id="opCancel">Zru≈°it</button>
        </form>
        <details style="margin-top:12px"><summary>üì• Hromadn√Ω import jmen (1 na ≈ô√°dek)</summary>
          <textarea id="bulk" rows="6" placeholder="Jana Nov√°kov√°\nPetr Dvo≈ô√°k\n‚Ä¶" style="width:100%; margin-top:8px"></textarea>
          <button class="btn" id="bulkBtn">P≈ôidat hromadnƒõ</button>
        </details>
      </section>
    </div>
  `);

  // Wire edit/delete
  document.querySelectorAll('[data-edit]').forEach(b=> b.onclick = ()=>{
    const o = state.operators.find(x=>x.id===b.dataset.edit);
    const f = document.getElementById('opForm');
    f.id.value = o.id; f.name.value = o.name; f.team.value = o.team||'';
  });
  document.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{
    if(confirm('Smazat oper√°tora? Z√°znamy z≈Østanou bez p≈ôi≈ôazen√≠.')){
      state.operators = state.operators.filter(x=>x.id!==b.dataset.del);
      save(); render();
    }
  });

  const form = document.getElementById('opForm');
  form.onsubmit = (e)=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    if(data.id){
      const i = state.operators.findIndex(o=>o.id===data.id);
      if(i>-1){ state.operators[i].name=data.name; state.operators[i].team=data.team; }
    } else {
      state.operators.push({id:uid(), name:data.name, team:data.team});
    }
    save(); render();
  };
  document.getElementById('opCancel').onclick = ()=>{ form.reset(); };

  document.getElementById('bulkBtn').onclick = ()=>{
    const lines = document.getElementById('bulk').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    lines.forEach(name=> state.operators.push({id:uid(), name}));
    save(); render();
  };
}

/********************
 * SETTINGS
 ********************/
function viewSettings(){
  setMain(`
    <div class="grid cols-2">
      <section class="card">
        <h3>‚öôÔ∏è Obecn√©</h3>
        <form id="contestForm" class="row">
          <label>Start: <input type="date" name="start" value="${state.contest.start}"></label>
          <label>Konec: <input type="date" name="end" value="${state.contest.end}"></label>
          <input name="name" placeholder="N√°zev soutƒõ≈æe" value="${escapeAttr(state.contest.name)}" style="flex:1">
          <button class="btn-cta">Ulo≈æit</button>
        </form>
        <details style="margin-top:8px"><summary>üéØ Miln√≠ky</summary>
          <div id="milestones">${state.contest.milestones.map((m,i)=>milestoneRow(m,i)).join('')}</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="addMilestone">+ Miln√≠k</button>
            <button class="btn" id="saveMilestones">Ulo≈æit miln√≠ky</button>
          </div>
        </details>
      </section>

      <section class="card">
        <h3>üè∑Ô∏è Aktivity a body</h3>
        <div id="activities">${state.activities.map(a=>activityRow(a)).join('')}</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="addActivity">+ Aktivita</button>
          <button class="btn" id="saveActivities">Ulo≈æit aktivity</button>
        </div>
      </section>

      <section class="card" style="grid-column:1 / -1">
        <h3>üßØ √ödr≈æba</h3>
        <div class="row">
          <button class="btn btn-accent" id="demoSeed">Naplnit uk√°zkov√Ωmi daty</button>
          <button class="btn btn-danger" id="resetAll">Smazat v≈°e</button>
        </div>
        <div class="mini" style="margin-top:6px">Pozn.: v≈°e bƒõ≈æ√≠ offline v prohl√≠≈æeƒçi (LocalStorage).</div>
      </section>
    </div>
  `);

  // Wire general form
  const cf = document.getElementById('contestForm');
  cf.onsubmit = (e)=>{ e.preventDefault(); const d = Object.fromEntries(new FormData(cf).entries()); state.contest.start=d.start; state.contest.end=d.end; state.contest.name=d.name; save(); flash('Ulo≈æeno.'); };

  document.getElementById('addMilestone').onclick = ()=>{
    state.contest.milestones.push({points:0,label:''});
    save(); viewSettings();
  };
  document.getElementById('saveMilestones').onclick = ()=>{
    const rows = [...document.querySelectorAll('[data-milestone]')].map(r=>({
      points:Number(r.querySelector('[name=points]').value||0),
      label:r.querySelector('[name=label]').value||''
    }));
    state.contest.milestones = rows.sort((a,b)=>a.points-b.points);
    save(); flash('Miln√≠ky ulo≈æeny.');
  };

  document.getElementById('addActivity').onclick = ()=>{
    state.activities.push({id:uid(), name:'Nov√° aktivita', points:0, category:''});
    save(); viewSettings();
  };
  document.getElementById('saveActivities').onclick = ()=>{
    const rows = [...document.querySelectorAll('[data-activity]')].map(r=>({
      id:r.dataset.id||uid(),
      name:r.querySelector('[name=name]').value||'',
      points:Number(r.querySelector('[name=points]').value||0),
      category:r.querySelector('[name=category]').value||''
    }));
    state.activities = rows;
    save(); flash('Aktivity ulo≈æeny.');
  };

  document.getElementById('demoSeed').onclick = ()=>{ seedDemo(); };
  document.getElementById('resetAll').onclick = resetAll;
}

function milestoneRow(m,i){
  return `<div class="row" data-milestone>
    <input name="points" type="number" value="${m.points}" style="width:120px" />
    <input name="label" value="${escapeAttr(m.label)}" style="flex:1" />
    <button class="btn btn-danger" onclick="removeMilestone(${i})">Smazat</button>
  </div>`
}
function removeMilestone(i){ state.contest.milestones.splice(i,1); save(); viewSettings(); }

function activityRow(a){
  return `<div class="row" data-activity data-id="${a.id}">
    <input name="name" value="${escapeAttr(a.name)}" style="flex:1" />
    <input name="points" type="number" value="${a.points}" style="width:120px" />
    <input name="category" value="${escapeAttr(a.category||'')}" placeholder="Kategorie" style="width:180px" />
    <button class="btn btn-danger" onclick="removeActivity('${a.id}')">Smazat</button>
  </div>`
}
function removeActivity(id){ state.activities = state.activities.filter(a=>a.id!==id); save(); viewSettings(); }

/********************
 * BACKUP (Export/Import)
 ********************/
function viewBackup(){
  setMain(`
    <section class="card">
      <h3>üíæ Export / Import</h3>
      <div class="row" style="margin-bottom:10px">
        <button class="btn-cta" id="exportBtn">Exportovat JSON</button>
        <input type="file" id="importFile" accept="application/json" />
        <button class="btn" id="importBtn">Importovat</button>
      </div>
      <textarea id="jsonArea" rows="12" style="width:100%" placeholder="Nebo vlo≈æte JSON ruƒçnƒõ a kliknƒõte na Importovat‚Ä¶">${escapeHTML(JSON.stringify(state, null, 2))}</textarea>
      <div class="mini" style="margin-top:6px">Export vytvo≈ô√≠ soubor s aktu√°ln√≠m stavem. Import p≈ôep√≠≈°e aktu√°ln√≠ data.</div>
    </section>
  `);

  document.getElementById('exportBtn').onclick = ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `santa_app_challenge_${todayISO()}.json`;
    a.click();
  };

  document.getElementById('importBtn').onclick = ()=>{
    const file = document.getElementById('importFile').files[0];
    if(file){
      const fr = new FileReader();
      fr.onload = ()=>{ try{ state = JSON.parse(fr.result); save(); render(); }catch(e){ alert('Neplatn√Ω JSON.'); } };
      fr.readAsText(file);
    } else {
      const txt = document.getElementById('jsonArea').value;
      try{ state = JSON.parse(txt); save(); render(); }catch(e){ alert('Neplatn√Ω JSON.'); }
    }
  };
}

/********************
 * V√Ωpoƒçty
 ********************/
function scoreByOperator(){
  const map={};
  state.logs.forEach(l=>{ map[l.operatorId]=(map[l.operatorId]||0)+Number(l.points||0); });
  return map;
}
function milestonePct(pts, milestones){
  if(!milestones.length) return 0;
  const max = milestones[milestones.length-1].points||1;
  return Math.max(0, Math.min(100, Math.round(pts/max*100)));
}
function groupByWeek(){
  const g={};
  state.logs.forEach(l=>{ const k=weekKey(l.date); (g[k]=g[k]||[]).push(l); });
  return g;
}
function leaderboard(logs){
  const map={};
  logs.forEach(l=>{ const name = state.operators.find(o=>o.id===l.operatorId)?.name||'(nezn√°m√Ω)'; map[name]=(map[name]||0)+Number(l.points||0); });
  return Object.entries(map).map(([name,points])=>({name,points})).sort((a,b)=>b.points-a.points);
}

/********************
 * Pomocn√© UI
 ********************/
function flash(msg){
  const d=document.createElement('div');
  d.textContent = msg; d.style.position='fixed'; d.style.right='16px'; d.style.bottom='16px'; d.style.background='#0a2d2b'; d.style.border='1px solid #1d6b61'; d.style.color='#c7f9ec'; d.style.padding='10px 12px'; d.style.borderRadius='10px'; d.style.zIndex='50';
  document.body.appendChild(d); setTimeout(()=>d.remove(),2000);
}
function escapeHTML(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function escapeAttr(s){ return escapeHTML(s).replace(/\n/g,' '); }

/********************
 * Sn√≠h (dekorace)
 ********************/
(function snow(){
  const c = document.getElementById('snow'); const ctx=c.getContext('2d');
  let w,h,flakes=[]; function resize(){ w= c.width = innerWidth; h = c.height = innerHeight; flakes = Array.from({length: Math.min(200, Math.floor(w/8))},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.8+0.4, s:Math.random()*0.6+0.2})) }
  window.addEventListener('resize', resize); resize();
  (function loop(){ ctx.clearRect(0,0,w,h); ctx.fillStyle='rgba(255,255,255,0.8)'; flakes.forEach(f=>{ ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); f.y += f.s; f.x += Math.sin(f.y*0.01)*0.2; if(f.y>h) f.y=-5; }); requestAnimationFrame(loop); })();
})();

/********************
 * Router & init
 ********************/
function render(){
  renderTabs();
  if(currentTab==='dashboard') viewDashboard();
  if(currentTab==='log') viewLog();
  if(currentTab==='operators') viewOperators();
  if(currentTab==='settings') viewSettings();
  if(currentTab==='backup') viewBackup();
}

/********************
 * Uk√°zkov√° data
 ********************/
function seedDemo(){
  if(!confirm('P≈ôepsat aktu√°ln√≠ data uk√°zkou?')) return;
  const names = ['Jana Nov√°kov√°','Petr Dvo≈ô√°k','Lucie Svobodov√°','Ji≈ô√≠ Kr√°l','Barbora Mal√°','Tom√°≈° Hor√°k'];
  state.operators = names.map(n=>({id:uid(), name:n, team:['A','B'][Math.floor(Math.random()*2)]}));
  state.logs = [];
  const acts = state.activities;
  for(let i=0;i<120;i++){
    const op = state.operators[Math.floor(Math.random()*state.operators.length)];
    const a = acts[Math.floor(Math.random()*acts.length)];
    const day = new Date(state.contest.start);
    day.setDate(day.getDate()+Math.floor(Math.random()*35));
    state.logs.push({id:uid(), date:day.toISOString().slice(0,10), operatorId:op.id, activityId:a.id, points:a.points, note:''});
  }
  save(); render(); flash('Uk√°zkov√° data nahr√°na.');
}

// Start app
render();
</script>


<!-- üîå Firebase SDK + integrace do aplikace -->
<script type="module">
  // 1) Naƒçten√≠ Firebase modul≈Ø z CDN
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, getDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // 2) üß© Sem vlo≈æte sv≈Øj Firebase config z konzole (nahraƒète hodnoty v objektu):
  const firebaseConfig = {
  apiKey: "AIzaSyB3rsUPwZrAhSIUhNP5st0NnIoBR9nlpZE",
  authDomain: "santa-challenge.firebaseapp.com",
  projectId: "santa-challenge",
  storageBucket: "santa-challenge.firebasestorage.app",
  messagingSenderId: "499140073635",
  appId: "1:499140073635:web:6c82ed4fb5795b36174716"
};

  // 3) Inicializace a zve≈ôejnƒõn√≠ kontextu
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  window.firebaseCtx = { app, auth, db };

  // 4) UI prvky p≈ôihl√°≈°en√≠
  const authState = document.getElementById('authState');
  const loginForm = document.getElementById('loginForm');
  const logoutBtn = document.getElementById('logoutBtn');

  async function loadCollectionSafe(name){
    try{ const snap = await getDocs(collection(db, name));
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }catch(e){ console.warn('loadCollectionSafe', name, e); return []; }
  }

  // 5) Napojen√≠ na existuj√≠c√≠ aplikaci ‚Äì p≈ôeps√°n√≠ zdroj≈Ø dat na Firestore (pokud je u≈æivatel p≈ôihl√°≈°en)
  async function syncFromCloud(){
    // Naƒçti logy (pro ≈æeb≈ô√≠ƒçek) a p≈ô√≠padnƒõ konfiguraci, pokud existuje v DB
    const logs = await loadCollectionSafe('logs');
    if(Array.isArray(logs) && logs.length){
      // p≈ôepi≈° lok√°ln√≠ logy daty z cloudu
      window.state.logs = logs.map(l=>({ id:l.id, date:l.date, operatorId:l.operatorId, activityId:l.activityId, points:l.points, note:l.note||'' }));
    }
    const acts = await loadCollectionSafe('activities');
    if(acts.length){ window.state.activities = acts.map(a=>({ id:a.id||a.uid||a.name, name:a.name, points:Number(a.points)||0, category:a.category||'' })); }
    const ops = await loadCollectionSafe('operators');
    if(ops.length){ window.state.operators = ops.map(o=>({ id:o.id||o.uid||o.name, name:o.name, team:o.team||'' })); }
    // contest config (single doc):/contest/config
    try{ const cfg = await getDoc(doc(db,'contest','config')); if(cfg.exists()){
      const c = cfg.data();
      window.state.contest.name = c.name || window.state.contest.name;
      window.state.contest.start = c.start || window.state.contest.start;
      window.state.contest.end   = c.end   || window.state.contest.end;
      if(Array.isArray(c.milestones)) window.state.contest.milestones = c.milestones;
    }}catch(e){ /* ignore */ }

    // p≈ôerenderuj UI s daty z cloudu
    window.render && window.render();
  }

  // 6) Ulo≈æen√≠ nov√©ho logu do Firestore a z√°kaz lok√°ln√≠ho ukl√°d√°n√≠, kdy≈æ je p≈ôihl√°≈°en
  async function addLogToCloud(data){
    if(!auth.currentUser){ alert('Nejprve se p≈ôihlas.'); return; }
    const payload = {
      date: data.date,
      operatorId: data.operatorId,
      activityId: data.activityId,
      points: Number(data.points||0),
      note: data.note||'',
      authorUid: auth.currentUser.uid,
      createdAt: new Date().toISOString()
    };
    await addDoc(collection(db,'logs'), payload);
  }

  // 7) P≈ôevzet√≠ formul√°≈ôe ‚ÄûRychl√Ω z√°znam‚Äú a zmƒõna chov√°n√≠ podle auth stavu
  function wireCloudOverrides(){
    const form = document.getElementById('quick-add');
    if(form){
      form.onsubmit = async (e)=>{
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());
        if(!auth.currentUser){ alert('Nejprve se p≈ôihlas.'); return; }
        await addLogToCloud(data);
        form.reset();
        // Po p≈ôid√°n√≠ naƒçti ƒçerstv√° data
        await syncFromCloud();
        window.flash && window.flash('Zaps√°no do Firestore.');
      };
    }
  }

  // 8) P≈ôihl√°≈°en√≠/odhl√°≈°en√≠
  if(loginForm){
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const { email, password } = Object.fromEntries(new FormData(loginForm).entries());
      try{ await signInWithEmailAndPassword(auth, email, password); loginForm.reset(); }
      catch(err){ alert('P≈ôihl√°≈°en√≠ se nepoda≈ôilo: '+(err?.message||err)); }
    });
  }
  if(logoutBtn){ logoutBtn.addEventListener('click', ()=> signOut(auth)); }

  // 9) Reakce na zmƒõnu p≈ôihl√°≈°en√≠ ‚Äì √∫prava UI a naƒçten√≠ dat
  onAuthStateChanged(auth, async (user)=>{
    const loginVisible = document.getElementById('loginForm');
    if(user){
      authState.textContent = `P≈ôihl√°≈°en: ${user.email}`;
      logoutBtn.style.display = 'inline-flex';
      if(loginVisible) loginVisible.style.display = 'none';
      await syncFromCloud();
      wireCloudOverrides();
    } else {
      authState.textContent = 'Nep≈ôihl√°≈°en';
      logoutBtn.style.display = 'none';
      if(loginVisible) loginVisible.style.display = 'flex';
    }
  });
</script>

</body>
</html>
