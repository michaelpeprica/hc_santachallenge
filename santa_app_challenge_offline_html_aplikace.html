<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Santa App Challenge â€“ Cesta k vÃ¡noÄnÃ­ kometÄ› (offline)</title>
  <meta name="description" content="Offline HTML aplikace pro vÃ¡noÄnÃ­ soutÄ›Å¾ operÃ¡torÅ¯: podpora mobilnÃ­ aplikace, prodeje a efektivity." />
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827cc;     /* gray-900 with alpha */
      --soft:#1f2937;        /* gray-800 */
      --muted:#94a3b8;       /* slate-400 */
      --text:#e5e7eb;        /* gray-200 */
      --brand:#22d3ee;       /* cyan-400 */
      --brand-2:#10b981;     /* emerald-500 */
      --accent:#f59e0b;      /* amber-500 */
      --danger:#ef4444;      /* red-500 */
      --success:#34d399;     /* green-400 */
      --card:#0b1226;        /* custom */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif; 
      background: radial-gradient(1200px 800px at 10% -10%, #1b2a52 0%, transparent 60%),
                  radial-gradient(900px 700px at 110% 10%, #16304f 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(1.2) blur(8px);
      background:linear-gradient(180deg, #0b1226cc, #0b122680);
      border-bottom:1px solid #1f2a44;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}
    .title{
      display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.4px;
    }
    .title .logo{font-size:28px}
    .subtitle{color:var(--muted); font-size:14px}

    /* Tabs */
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .tab{padding:10px 14px; border-radius:12px; background:#0d1731; color:#cbd5e1; cursor:pointer; border:1px solid transparent; user-select:none}
    .tab.active{background:linear-gradient(180deg,#102046,#0e1a37); border-color:#20325c; color:white; box-shadow:0 0 0 1px #0d1b36 inset, 0 10px 30px -20px #22d3ee}
    .grid{display:grid; gap:16px}
    @media(min-width:900px){.grid.cols-2{grid-template-columns:1fr 1fr}}
    @media(min-width:1200px){.grid.cols-3{grid-template-columns:2fr 1fr 1fr}}

    .card{
      background:linear-gradient(180deg,#0e1833,#0b1226); border:1px solid #1c2a4b; border-radius:16px; padding:16px;
      box-shadow:0 10px 30px -22px #000 inset, 0 12px 40px -28px #000;
    }
    .card h3{margin:0 0 8px 0; font-size:16px}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    input,select,button,textarea{
      background:#0a1329; color:#e2e8f0; border:1px solid #1f2e54; padding:10px 12px; border-radius:12px; font:inherit
    }
    input::placeholder, textarea::placeholder{color:#64748b}
    button{cursor:pointer}
    .btn{background:linear-gradient(180deg,#0f2349,#0c1a35); border-color:#1f2e54}
    .btn-primary{background:linear-gradient(180deg,#0f2b51,#0d2346); border-color:#2b436f}
    .btn-cta{background:linear-gradient(180deg,#0e3b39,#0a2d2b); border-color:#1d6b61}
    .btn-danger{background:linear-gradient(180deg,#451515,#2a0f0f); border-color:#6b1f1f}
    .btn-accent{background:linear-gradient(180deg,#3c2a08,#2a1c05); border-color:#5a3c10}

    .kpi{display:flex; gap:12px; align-items:baseline; padding:12px 0}
    .kpi .v{font-size:28px; font-weight:800}
    .kpi .l{color:var(--muted)}

    .leaderboard table{width:100%; border-collapse:collapse}
    .leaderboard th,.leaderboard td{padding:10px; border-bottom:1px dashed #223357; text-align:left}
    .leaderboard tr:hover{background:#0b1735}

    .progress{height:14px; background:#0a142f; border:1px solid #1b2b56; border-radius:999px; overflow:hidden}
    .progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--brand-2));}

    .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#0a1d18; border:1px solid #1d6b61; color:#c7f9ec; font-size:12px}
    .pill{display:inline-flex; padding:2px 8px; border-radius:999px; background:#0e1730; border:1px solid #20325c; color:#e2e8f0; font-size:12px}

    .footer{color:#64748b; font-size:12px; text-align:center; padding:24px}

    .snow{position:fixed; inset:0; pointer-events:none; z-index:0}
    .content{position:relative; z-index:1}

    .mini{font-size:12px; color:var(--muted)}

    details summary{cursor:pointer}
  </style>
</head>
<body>
  <canvas class="snow" id="snow"></canvas>
  <header>
    <div class="wrap">
      <div class="title">
        <div class="logo">ğŸ…âœ¨</div>
        <div>
          <div>Santa App Challenge â€” <span class="pill">Cesta k vÃ¡noÄnÃ­ kometÄ›</span></div>
          <div class="subtitle">GamifikovanÃ¡ soutÄ›Å¾ pro operÃ¡tory: podpora mobilnÃ­ aplikace, prodeje a efektivity. Offline, bez serveru (LocalStorage).</div>
        </div>
      </div>
      <nav class="tabs" id="tabs"></nav>
    </div>
  </header>

  <main class="wrap content" id="app"></main>

  <div class="footer">Â© 2025 â€“ InternÃ­ soutÄ›Å¾nÃ­ nÃ¡stroj. Data se uklÃ¡dajÃ­ pouze lokÃ¡lnÄ› do vaÅ¡eho prohlÃ­Å¾eÄe.</div>

<script>
/********************
 * JednoduchÃ½ stav + uloÅ¾enÃ­
 ********************/
const STORAGE_KEY = 'santa_app_challenge_v1';
const todayISO = () => new Date().toISOString().slice(0,10);
const defaultConfig = {
  contest:{
    name:"Santa App Challenge",
    start:"2025-11-15",
    end:"2025-12-22",
    milestones:[
      {points:50,  label:"ğŸ PernÃ­kovÃ© mÄ›steÄko"},
      {points:120, label:"ğŸ›· SobÃ­ prÅ¯smyk"},
      {points:220, label:"ğŸ  VÃ¡noÄnÃ­ vesnice"},
      {points:350, label:"ğŸŒŸ ZlatÃ¡ kometa"}
    ]
  },
  activities:[
    {id:'app_activation', name:'Aktivace mobilnÃ­ aplikace', points:10, category:'Appka'},
    {id:'product_small', name:'Prodej doplÅˆkovÃ© sluÅ¾by', points:15, category:'Prodej'},
    {id:'product_big', name:'UzavÅ™enÃ½ produkt (ÃºvÄ›r/karta)', points:25, category:'Prodej'},
    {id:'sales_over', name:'PÅ™ekroÄenÃ­ cÃ­le o 10 % (tÃ½den)', points:20, category:'Prodej', bonus:true},
    {id:'efficiency_kpi', name:'DodrÅ¾enÃ­ KPI (AHT/SLA)', points:5, category:'Efektivita'},
    {id:'csat', name:'PozitivnÃ­ hodnocenÃ­ zÃ¡kaznÃ­ka', points:10, category:'Kvalita'},
    {id:'creative', name:'KreativnÃ­ nÃ¡pad / mini video', points:20, category:'Kreativa'}
  ],
  operators:[],
  logs:[], // {id, date, operatorId, activityId, points, note}
};

let state = load() || defaultConfig;

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function load(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null }
}
function resetAll(){
  if(confirm('Opravdu smazat vÅ¡echna lokÃ¡lnÃ­ data?')){
    localStorage.removeItem(STORAGE_KEY);
    state = JSON.parse(JSON.stringify(defaultConfig));
    render();
  }
}

/********************
 * PomocnÃ© funkce
 ********************/
const by = f => (a,b)=> f(a)>f(b)?1:f(a)<f(b)?-1:0;
const sum = arr => arr.reduce((a,b)=>a+b,0);
const uid = () => Math.random().toString(36).slice(2,9);
const weekKey = (dStr)=>{ const d=new Date(dStr); const oneJan = new Date(d.getFullYear(),0,1); const day = Math.floor((d-oneJan)/86400000)+oneJan.getDay(); const w = Math.ceil(day/7); return `${d.getFullYear()}-W${String(w).padStart(2,'0')}`};
const inRange = (dStr, start, end)=>{ const d=new Date(dStr); return (!start||d>=new Date(start)) && (!end||d<=new Date(end)); };

/********************
 * UI Skeleton
 ********************/
const TABS = [
  {id:'dashboard', label:'ğŸ“Š PÅ™ehled'},
  {id:'log', label:'ğŸ“ ZÃ¡znamy'},
  {id:'operators', label:'ğŸ‘¥ OperÃ¡toÅ™i'},
  {id:'settings', label:'âš™ï¸ NastavenÃ­'},
  {id:'backup', label:'ğŸ’¾ Export/Import'}
];
let currentTab = 'dashboard';

function renderTabs(){
  const el = document.getElementById('tabs');
  el.innerHTML = '';
  TABS.forEach(t=>{
    const b = document.createElement('button');
    b.className = 'tab'+(t.id===currentTab?' active':'');
    b.textContent = t.label;
    b.onclick = ()=>{ currentTab=t.id; render(); };
    el.appendChild(b);
  })
}

function setMain(html){
  const app = document.getElementById('app');
  app.innerHTML = html;
}

/********************
 * DASHBOARD
 ********************/
function viewDashboard(){
  const {start,end,milestones} = state.contest;
  const totalsByOp = scoreByOperator();
  const totalPoints = sum(Object.values(totalsByOp));
  const totalLogs = state.logs.length;
  const appActivations = state.logs.filter(l=>l.activityId==='app_activation').length;

  const top3 = Object.entries(totalsByOp)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,5)
    .map(([opId,pts],i)=>{
      const op = state.operators.find(o=>o.id===opId) || {name:'(neznÃ¡mÃ½)'};
      const pct = milestonePct(pts, milestones);
      return `<tr>
        <td>${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'â­'}</td>
        <td>${escapeHTML(op.name)}</td>
        <td><div class="progress"><span style="width:${pct}%"></span></div></td>
        <td style="text-align:right">${pts}</td>
      </tr>`
    }).join('');

  const weeks = groupByWeek();
  const lastWeekKey = Object.keys(weeks).sort().slice(-1)[0];
  const lastWeek = weeks[lastWeekKey]||[];
  const weekBoard = leaderboard(lastWeek);

  setMain(`
    <div class="grid cols-3">
      <section class="card">
        <h3>ğŸ„ Stav soutÄ›Å¾e</h3>
        <div class="kpi"><div class="v">${totalPoints}</div><div class="l">Celkem bodÅ¯</div></div>
        <div class="kpi"><div class="v">${totalLogs}</div><div class="l">ZÃ¡znamÅ¯</div></div>
        <div class="kpi"><div class="v">${appActivations}</div><div class="l">AktivacÃ­ appky</div></div>
        <div class="mini">ObdobÃ­: <b>${start}</b> â†’ <b>${end}</b></div>
      </section>

      <section class="card leaderboard">
        <h3>ğŸŒŸ CelkovÃ© poÅ™adÃ­</h3>
        <table>
          <thead><tr><th></th><th>OperÃ¡tor</th><th>Postup</th><th style="text-align:right">Body</th></tr></thead>
          <tbody>${top3 || ''}</tbody>
        </table>
      </section>

      <section class="card leaderboard">
        <h3>â±ï¸ TÃ½dennÃ­ hvÄ›zdy <span class="pill">${lastWeekKey||'â€”'}</span></h3>
        ${renderLeaderboardTable(weekBoard)}
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h3>ğŸ—ºï¸ Mapa milnÃ­kÅ¯</h3>
      ${state.operators.length? state.operators.map(op=>{
        const pts = totalsByOp[op.id]||0;
        const pct = milestonePct(pts, milestones);
        const next = milestones.find(m=>pts<m.points);
        const label = next? `${pts}/${next.points} â†’ ${next.label}` : `${pts} â€“ dosaÅ¾eno ${milestones[milestones.length-1].label} ğŸŒŸ`;
        return `<div class="row" style="align-items:center; margin:10px 0">
          <div style="min-width:180px">${escapeHTML(op.name)}</div>
          <div class="progress" style="flex:1"><span style="width:${pct}%"></span></div>
          <div class="mini" style="min-width:240px; text-align:right">${label}</div>
        </div>`
      }).join('') : '<div class="mini">PÅ™idejte operÃ¡tory v zÃ¡loÅ¾ce <b>OperÃ¡toÅ™i</b>.</div>'}
    </section>

    <section class="card" style="margin-top:16px">
      <h3>â• RychlÃ½ zÃ¡znam</h3>
      ${quickAddForm()}
    </section>
  `);

  // wire quick add
  wireQuickAdd();
}

function renderLeaderboardTable(board){
  return `
    <table>
      <thead><tr><th>#</th><th>OperÃ¡tor</th><th style="text-align:right">Body</th></tr></thead>
      <tbody>
      ${board.map((r,i)=>`<tr><td>${i<3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]:'â€”'}</td><td>${escapeHTML(r.name)}</td><td style="text-align:right">${r.points}</td></tr>`).join('')}
      </tbody>
    </table>
  `
}

function quickAddForm(){
  const opOpts = state.operators.map(o=>`<option value="${o.id}">${escapeHTML(o.name)}</option>`).join('');
  const actOpts = state.activities.map(a=>`<option value="${a.id}" data-points="${a.points}">${escapeHTML(a.name)} (+${a.points})</option>`).join('');
  return `
    <form id="quick-add" class="row">
      <select name="operatorId" required><option value="">â€“ OperÃ¡tor â€“</option>${opOpts}</select>
      <select name="activityId" required id="qa-activity"><option value="">â€“ Aktivita â€“</option>${actOpts}</select>
      <input name="points" id="qa-points" type="number" step="1" placeholder="Body (auto)" style="width:140px" />
      <input name="date" type="date" value="${todayISO()}" />
      <input name="note" type="text" placeholder="PoznÃ¡mka (volitelnÃ©)" style="flex:1" />
      <button class="btn-cta">PÅ™idat</button>
    </form>
  `;
}
function wireQuickAdd(){
  const f = document.getElementById('quick-add'); if(!f) return;
  const actSel = document.getElementById('qa-activity');
  const ptsInp = document.getElementById('qa-points');
  actSel.onchange = ()=>{
    const opt = actSel.options[actSel.selectedIndex];
    ptsInp.value = opt?.dataset?.points || '';
  }
  f.onsubmit = (e)=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(f).entries());
    if(!data.operatorId || !data.activityId) return;
    const pts = Number(data.points || state.activities.find(a=>a.id===data.activityId)?.points || 0);
    state.logs.push({id:uid(), date:data.date||todayISO(), operatorId:data.operatorId, activityId:data.activityId, points:pts, note:data.note||''});
    save(); render();
  }
}

/********************
 * LOGS
 ********************/
function viewLog(){
  const rows = state.logs
    .slice().sort((a,b)=> new Date(b.date)-new Date(a.date))
    .map(l=>{
      const op = state.operators.find(o=>o.id===l.operatorId)?.name||'â€”';
      const act = state.activities.find(a=>a.id===l.activityId)?.name||'â€”';
      return `<tr>
        <td>${l.date}</td>
        <td>${escapeHTML(op)}</td>
        <td>${escapeHTML(act)}</td>
        <td style="text-align:right">${l.points}</td>
        <td class="mini">${escapeHTML(l.note||'')}</td>
        <td style="text-align:right"><button class="btn btn-danger" data-del="${l.id}">Smazat</button></td>
      </tr>`
    }).join('');

  setMain(`
    <section class="card">
      <h3>ğŸ“ ZÃ¡znamy aktivit</h3>
      <div class="row" style="margin-bottom:10px">
        <input id="filterStart" type="date" value="${state.contest.start}">
        <input id="filterEnd" type="date" value="${state.contest.end}">
        <button class="btn" id="btnFilter">Filtrovat</button>
        <button class="btn" id="btnClear">ZruÅ¡it filtr</button>
      </div>
      <div class="leaderboard" style="overflow:auto; max-height:60vh">
        <table>
          <thead><tr><th>Datum</th><th>OperÃ¡tor</th><th>Aktivita</th><th style="text-align:right">Body</th><th>Pozn.</th><th></th></tr></thead>
          <tbody id="logBody">${rows}</tbody>
        </table>
      </div>
    </section>
  `);

  document.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{ delLog(b.dataset.del); });
  document.getElementById('btnFilter').onclick = ()=>{
    const s = document.getElementById('filterStart').value;
    const e = document.getElementById('filterEnd').value;
    filterLogs(s,e);
  };
  document.getElementById('btnClear').onclick = ()=> render();
}

function filterLogs(start,end){
  const body = document.getElementById('logBody');
  body.innerHTML = state.logs.filter(l=>inRange(l.date,start,end)).sort((a,b)=>new Date(b.date)-new Date(a.date)).map(l=>{
    const op = state.operators.find(o=>o.id===l.operatorId)?.name||'â€”';
    const act = state.activities.find(a=>a.id===l.activityId)?.name||'â€”';
    return `<tr>
      <td>${l.date}</td>
      <td>${escapeHTML(op)}</td>
      <td>${escapeHTML(act)}</td>
      <td style="text-align:right">${l.points}</td>
      <td class="mini">${escapeHTML(l.note||'')}</td>
      <td style="text-align:right"><button class="btn btn-danger" data-del="${l.id}">Smazat</button></td>
    </tr>`
  }).join('');
  body.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{ delLog(b.dataset.del); });
}

function delLog(id){
  state.logs = state.logs.filter(l=>l.id!==id);
  save(); render();
}

/********************
 * OPERATORS
 ********************/
function viewOperators(){
  const list = state.operators.map(o=>{
    const pts = scoreByOperator()[o.id]||0;
    return `<tr>
      <td>${escapeHTML(o.name)}</td>
      <td class="mini">${escapeHTML(o.team||'')}</td>
      <td style="text-align:right">${pts}</td>
      <td style="text-align:right">
        <button class="btn" data-edit="${o.id}">Upravit</button>
        <button class="btn btn-danger" data-del="${o.id}">Smazat</button>
      </td>
    </tr>`
  }).join('');

  setMain(`
    <div class="grid cols-2">
      <section class="card">
        <h3>ğŸ‘¥ Seznam operÃ¡torÅ¯</h3>
        <div class="leaderboard" style="overflow:auto; max-height:60vh">
          <table>
            <thead><tr><th>JmÃ©no</th><th>TÃ½m</th><th style="text-align:right">Body</th><th></th></tr></thead>
            <tbody>${list||''}</tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h3>â• PÅ™idat / Upravit</h3>
        <form id="opForm" class="row">
          <input type="hidden" name="id" />
          <input name="name" placeholder="JmÃ©no a pÅ™Ã­jmenÃ­" required style="flex:1" />
          <input name="team" placeholder="TÃ½m (volitelnÃ©)" />
          <button class="btn-cta" style="min-width:140px">UloÅ¾it</button>
          <button type="button" class="btn" id="opCancel">ZruÅ¡it</button>
        </form>
        <details style="margin-top:12px"><summary>ğŸ“¥ HromadnÃ½ import jmen (1 na Å™Ã¡dek)</summary>
          <textarea id="bulk" rows="6" placeholder="Jana NovÃ¡kovÃ¡\nPetr DvoÅ™Ã¡k\nâ€¦" style="width:100%; margin-top:8px"></textarea>
          <button class="btn" id="bulkBtn">PÅ™idat hromadnÄ›</button>
        </details>
      </section>
    </div>
  `);

  // Wire edit/delete
  document.querySelectorAll('[data-edit]').forEach(b=> b.onclick = ()=>{
    const o = state.operators.find(x=>x.id===b.dataset.edit);
    const f = document.getElementById('opForm');
    f.id.value = o.id; f.name.value = o.name; f.team.value = o.team||'';
  });
  document.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{
    if(confirm('Smazat operÃ¡tora? ZÃ¡znamy zÅ¯stanou bez pÅ™iÅ™azenÃ­.')){
      state.operators = state.operators.filter(x=>x.id!==b.dataset.del);
      save(); render();
    }
  });

  const form = document.getElementById('opForm');
  form.onsubmit = (e)=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    if(data.id){
      const i = state.operators.findIndex(o=>o.id===data.id);
      if(i>-1){ state.operators[i].name=data.name; state.operators[i].team=data.team; }
    } else {
      state.operators.push({id:uid(), name:data.name, team:data.team});
    }
    save(); render();
  };
  document.getElementById('opCancel').onclick = ()=>{ form.reset(); };

  document.getElementById('bulkBtn').onclick = ()=>{
    const lines = document.getElementById('bulk').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    lines.forEach(name=> state.operators.push({id:uid(), name}));
    save(); render();
  };
}

/********************
 * SETTINGS
 ********************/
function viewSettings(){
  setMain(`
    <div class="grid cols-2">
      <section class="card">
        <h3>âš™ï¸ ObecnÃ©</h3>
        <form id="contestForm" class="row">
          <label>Start: <input type="date" name="start" value="${state.contest.start}"></label>
          <label>Konec: <input type="date" name="end" value="${state.contest.end}"></label>
          <input name="name" placeholder="NÃ¡zev soutÄ›Å¾e" value="${escapeAttr(state.contest.name)}" style="flex:1">
          <button class="btn-cta">UloÅ¾it</button>
        </form>
        <details style="margin-top:8px"><summary>ğŸ¯ MilnÃ­ky</summary>
          <div id="milestones">${state.contest.milestones.map((m,i)=>milestoneRow(m,i)).join('')}</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="addMilestone">+ MilnÃ­k</button>
            <button class="btn" id="saveMilestones">UloÅ¾it milnÃ­ky</button>
          </div>
        </details>
      </section>

      <section class="card">
        <h3>ğŸ·ï¸ Aktivity a body</h3>
        <div id="activities">${state.activities.map(a=>activityRow(a)).join('')}</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="addActivity">+ Aktivita</button>
          <button class="btn" id="saveActivities">UloÅ¾it aktivity</button>
        </div>
      </section>

      <section class="card" style="grid-column:1 / -1">
        <h3>ğŸ§¯ ÃšdrÅ¾ba</h3>
        <div class="row">
          <button class="btn btn-accent" id="demoSeed">Naplnit ukÃ¡zkovÃ½mi daty</button>
          <button class="btn btn-danger" id="resetAll">Smazat vÅ¡e</button>
        </div>
        <div class="mini" style="margin-top:6px">Pozn.: vÅ¡e bÄ›Å¾Ã­ offline v prohlÃ­Å¾eÄi (LocalStorage).</div>
      </section>
    </div>
  `);

  // Wire general form
  const cf = document.getElementById('contestForm');
  cf.onsubmit = (e)=>{ e.preventDefault(); const d = Object.fromEntries(new FormData(cf).entries()); state.contest.start=d.start; state.contest.end=d.end; state.contest.name=d.name; save(); flash('UloÅ¾eno.'); };

  document.getElementById('addMilestone').onclick = ()=>{
    state.contest.milestones.push({points:0,label:''});
    save(); viewSettings();
  };
  document.getElementById('saveMilestones').onclick = ()=>{
    const rows = [...document.querySelectorAll('[data-milestone]')].map(r=>({
      points:Number(r.querySelector('[name=points]').value||0),
      label:r.querySelector('[name=label]').value||''
    }));
    state.contest.milestones = rows.sort((a,b)=>a.points-b.points);
    save(); flash('MilnÃ­ky uloÅ¾eny.');
  };

  document.getElementById('addActivity').onclick = ()=>{
    state.activities.push({id:uid(), name:'NovÃ¡ aktivita', points:0, category:''});
    save(); viewSettings();
  };
  document.getElementById('saveActivities').onclick = ()=>{
    const rows = [...document.querySelectorAll('[data-activity]')].map(r=>({
      id:r.dataset.id||uid(),
      name:r.querySelector('[name=name]').value||'',
      points:Number(r.querySelector('[name=points]').value||0),
      category:r.querySelector('[name=category]').value||''
    }));
    state.activities = rows;
    save(); flash('Aktivity uloÅ¾eny.');
  };

  document.getElementById('demoSeed').onclick = ()=>{ seedDemo(); };
  document.getElementById('resetAll').onclick = resetAll;
}

function milestoneRow(m,i){
  return `<div class="row" data-milestone>
    <input name="points" type="number" value="${m.points}" style="width:120px" />
    <input name="label" value="${escapeAttr(m.label)}" style="flex:1" />
    <button class="btn btn-danger" onclick="removeMilestone(${i})">Smazat</button>
  </div>`
}
function removeMilestone(i){ state.contest.milestones.splice(i,1); save(); viewSettings(); }

function activityRow(a){
  return `<div class="row" data-activity data-id="${a.id}">
    <input name="name" value="${escapeAttr(a.name)}" style="flex:1" />
    <input name="points" type="number" value="${a.points}" style="width:120px" />
    <input name="category" value="${escapeAttr(a.category||'')}" placeholder="Kategorie" style="width:180px" />
    <button class="btn btn-danger" onclick="removeActivity('${a.id}')">Smazat</button>
  </div>`
}
function removeActivity(id){ state.activities = state.activities.filter(a=>a.id!==id); save(); viewSettings(); }

/********************
 * BACKUP (Export/Import)
 ********************/
function viewBackup(){
  setMain(`
    <section class="card">
      <h3>ğŸ’¾ Export / Import</h3>
      <div class="row" style="margin-bottom:10px">
        <button class="btn-cta" id="exportBtn">Exportovat JSON</button>
        <input type="file" id="importFile" accept="application/json" />
        <button class="btn" id="importBtn">Importovat</button>
      </div>
      <textarea id="jsonArea" rows="12" style="width:100%" placeholder="Nebo vloÅ¾te JSON ruÄnÄ› a kliknÄ›te na Importovatâ€¦">${escapeHTML(JSON.stringify(state, null, 2))}</textarea>
      <div class="mini" style="margin-top:6px">Export vytvoÅ™Ã­ soubor s aktuÃ¡lnÃ­m stavem. Import pÅ™epÃ­Å¡e aktuÃ¡lnÃ­ data.</div>
    </section>
  `);

  document.getElementById('exportBtn').onclick = ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `santa_app_challenge_${todayISO()}.json`;
    a.click();
  };

  document.getElementById('importBtn').onclick = ()=>{
    const file = document.getElementById('importFile').files[0];
    if(file){
      const fr = new FileReader();
      fr.onload = ()=>{ try{ state = JSON.parse(fr.result); save(); render(); }catch(e){ alert('NeplatnÃ½ JSON.'); } };
      fr.readAsText(file);
    } else {
      const txt = document.getElementById('jsonArea').value;
      try{ state = JSON.parse(txt); save(); render(); }catch(e){ alert('NeplatnÃ½ JSON.'); }
    }
  };
}

/********************
 * VÃ½poÄty
 ********************/
function scoreByOperator(){
  const map={};
  state.logs.forEach(l=>{ map[l.operatorId]=(map[l.operatorId]||0)+Number(l.points||0); });
  return map;
}
function milestonePct(pts, milestones){
  if(!milestones.length) return 0;
  const max = milestones[milestones.length-1].points||1;
  return Math.max(0, Math.min(100, Math.round(pts/max*100)));
}
function groupByWeek(){
  const g={};
  state.logs.forEach(l=>{ const k=weekKey(l.date); (g[k]=g[k]||[]).push(l); });
  return g;
}
function leaderboard(logs){
  const map={};
  logs.forEach(l=>{ const name = state.operators.find(o=>o.id===l.operatorId)?.name||'(neznÃ¡mÃ½)'; map[name]=(map[name]||0)+Number(l.points||0); });
  return Object.entries(map).map(([name,points])=>({name,points})).sort((a,b)=>b.points-a.points);
}

/********************
 * PomocnÃ© UI
 ********************/
function flash(msg){
  const d=document.createElement('div');
  d.textContent = msg; d.style.position='fixed'; d.style.right='16px'; d.style.bottom='16px'; d.style.background='#0a2d2b'; d.style.border='1px solid #1d6b61'; d.style.color='#c7f9ec'; d.style.padding='10px 12px'; d.style.borderRadius='10px'; d.style.zIndex='50';
  document.body.appendChild(d); setTimeout(()=>d.remove(),2000);
}
function escapeHTML(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function escapeAttr(s){ return escapeHTML(s).replace(/\n/g,' '); }

/********************
 * SnÃ­h (dekorace)
 ********************/
(function snow(){
  const c = document.getElementById('snow'); const ctx=c.getContext('2d');
  let w,h,flakes=[]; function resize(){ w= c.width = innerWidth; h = c.height = innerHeight; flakes = Array.from({length: Math.min(200, Math.floor(w/8))},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.8+0.4, s:Math.random()*0.6+0.2})) }
  window.addEventListener('resize', resize); resize();
  (function loop(){ ctx.clearRect(0,0,w,h); ctx.fillStyle='rgba(255,255,255,0.8)'; flakes.forEach(f=>{ ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); f.y += f.s; f.x += Math.sin(f.y*0.01)*0.2; if(f.y>h) f.y=-5; }); requestAnimationFrame(loop); })();
})();

/********************
 * Router & init
 ********************/
function render(){
  renderTabs();
  if(currentTab==='dashboard') viewDashboard();
  if(currentTab==='log') viewLog();
  if(currentTab==='operators') viewOperators();
  if(currentTab==='settings') viewSettings();
  if(currentTab==='backup') viewBackup();
}

/********************
 * UkÃ¡zkovÃ¡ data
 ********************/
function seedDemo(){
  if(!confirm('PÅ™epsat aktuÃ¡lnÃ­ data ukÃ¡zkou?')) return;
  const names = ['Jana NovÃ¡kovÃ¡','Petr DvoÅ™Ã¡k','Lucie SvobodovÃ¡','JiÅ™Ã­ KrÃ¡l','Barbora MalÃ¡','TomÃ¡Å¡ HorÃ¡k'];
  state.operators = names.map(n=>({id:uid(), name:n, team:['A','B'][Math.floor(Math.random()*2)]}));
  state.logs = [];
  const acts = state.activities;
  for(let i=0;i<120;i++){
    const op = state.operators[Math.floor(Math.random()*state.operators.length)];
    const a = acts[Math.floor(Math.random()*acts.length)];
    const day = new Date(state.contest.start);
    day.setDate(day.getDate()+Math.floor(Math.random()*35));
    state.logs.push({id:uid(), date:day.toISOString().slice(0,10), operatorId:op.id, activityId:a.id, points:a.points, note:''});
  }
  save(); render(); flash('UkÃ¡zkovÃ¡ data nahrÃ¡na.');
}

// Start app
render();
</script>
</body>
</html>
