<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>V√°noƒçn√≠ v√Ωzva 2025 ‚Ä¢ Home Credit</title>
  <style>
    :root{
      --bg: #0c1222;
      --bg-soft:#111a33;
      --card:#152043;
      --text:#e7f0ff;
      --muted:#a3b0c7;
      --accent:#e64564;
      --accent-2:#2ad1ff;
      --success:#35d399;
      --warn:#f59e0b;
      --shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    [data-theme="light"]{
      --bg: #f5f7fb; --bg-soft:#ffffff; --card:#ffffff; --text:#1b2430; --muted:#556072; --accent:#c2185b; --accent-2:#0ea5e9; --success:#16a34a; --warn:#d97706;
    }
    html,body{height:100%;}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text);} 
    .app-wrap{min-height:100%; display:grid; grid-template-rows:auto auto 1fr auto;}
    header{position:relative; z-index:2; display:flex; align-items:center; gap:.75rem; justify-content:space-between; padding:12px 16px; background:linear-gradient(180deg, rgba(0,0,0,.25), transparent), var(--bg-soft); box-shadow:var(--shadow);} 
    header .brand{display:flex; align-items:center; gap:.75rem;}
    .brand .logo{width:36px; height:36px; border-radius:10px; background: conic-gradient(from 0deg, var(--accent), var(--accent-2)); box-shadow:0 6px 20px rgba(230,69,100,.35);} 
    .brand h1{font-size:1.05rem; margin:0; letter-spacing:.3px}
    header nav{display:flex; gap:.5rem; align-items:center}
    button, .btn{appearance:none; border:none; outline:none; border-radius:14px; padding:.6rem .9rem; background:var(--accent); color:white; font-weight:600; cursor:pointer; box-shadow:var(--shadow);}    
    .btn.secondary{background:var(--card); color:var(--text); border:1px solid rgba(255,255,255,.08)}
    .btn.ghost{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.15)}
    .btn.small{padding:.45rem .7rem; border-radius:12px; font-size:.875rem}

    /* Real‚Äëtime banner */
    .banner{display:none; align-items:center; gap:.6rem; padding:10px 16px; background:linear-gradient(180deg, rgba(0,0,0,.25), transparent), #1a243f; color:#e9eefc; border-bottom:1px solid rgba(255,255,255,.08)}
    .banner.show{display:flex}
    .banner .tag{font-weight:700; background:#0c8; color:#012; padding:.1rem .5rem; border-radius:999px}
    .banner .warn{background:#f59e0b; color:#220}
    .banner .err{background:#ef4444; color:#200}

    main{position:relative; z-index:1; padding:16px; display:grid; gap:16px; max-width:1100px; margin-inline:auto}

    .card{background:var(--card); border-radius:22px; padding:16px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,.06)}
    .card h2{margin:.3rem 0 0.75rem 0; font-size:1.05rem}

    .muted{color:var(--muted); font-size:.9rem}

    .stack{display:flex; flex-direction:column; gap:10px}
    .row{display:flex; gap:10px; align-items:center}

    .progress{height:14px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.08)); border-radius:999px; position:relative; overflow:hidden;}
    .progress .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); transition:width .7s ease}

    .leaderboard-item{display:grid; grid-template-columns: 52px 1fr auto; gap:12px; align-items:center}
    .avatar{width:52px; height:52px; border-radius:15px; background:linear-gradient(225deg, var(--accent-2), var(--accent)); display:grid; place-items:center; font-weight:800; color:white}
    .medal{font-size:1.25rem}

    .badge{display:inline-block; margin-left:.5rem; padding:.15rem .5rem; font-size:.75rem; border-radius:999px; background:linear-gradient(90deg, var(--accent-2), var(--accent)); color:#fff; box-shadow:var(--shadow)}

    .tabs{display:flex; gap:6px; flex-wrap:wrap}
    .tab{padding:.55rem .8rem; border-radius:12px; background:transparent; border:1px solid rgba(255,255,255,.15); cursor:pointer}
    .tab.active{background:var(--accent); color:white; border-color:transparent}

    .footer{opacity:.7; padding:10px 16px; font-size:.85rem}

    /* Snow canvas covers viewport */
    #snow{position:fixed; inset:0; pointer-events:none; z-index:0}

    /* Auth screen */
    .auth{max-width:560px; margin: 4vh auto;}
    .auth h2{margin-top:0}
    .input{background:var(--bg); border:1px solid rgba(255,255,255,.12); color:var(--text); padding:.7rem .8rem; border-radius:12px; width:100%}
    label{font-size:.85rem; color:var(--muted)}
    form .row{justify-content:space-between}

    /* Festive background (simple vector hills) */
    .bg-illustration{position:fixed; inset:0; z-index:0; opacity:.25; background:
      radial-gradient(60% 35% at 50% 105%, rgba(255,255,255,.35), transparent 70%),
      linear-gradient(to top, #0b1330 0%, transparent 60%),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1920" height="800" viewBox="0 0 1920 800"><defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop stop-color="%23ffffff" stop-opacity="0.6"/><stop offset="1" stop-color="%23ffffff" stop-opacity="0.15"/></linearGradient></defs><g fill="url(%23g)"><path d="M0 650 C300 590 420 620 700 650 C980 680 1100 630 1400 600 C1700 570 1820 610 1920 640 L1920 800 L0 800 Z"/><path d="M0 720 C300 680 450 700 740 720 C1030 740 1220 710 1500 690 C1780 670 1870 700 1920 730 L1920 800 L0 800 Z"/></g></svg>') center bottom / cover no-repeat;
    }

    .hidden{display:none}
  </style>
</head>
<body>
  <canvas id="snow"></canvas>
  <div class="bg-illustration" aria-hidden="true"></div>
  <div class="app-wrap" id="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>V√°noƒçn√≠ v√Ωzva 2025</h1>
      </div>
      <nav>
        <button class="btn small" id="themeToggle" title="P≈ôepnout t√©ma">üåì T√©ma</button>
        <button class="btn small ghost" id="signOutBtn" title="Odhl√°sit">Odhl√°sit</button>
      </nav>
    </header>

    <div id="rtBanner" class="banner" role="status" aria-live="polite">
      <span class="tag warn" id="rtStatusTag">OFFLINE</span>
      <span id="rtStatusText">Jste offline. Zobrazuji posledn√≠ zn√°m√° data.</span>
      <button class="btn small ghost" id="rtRetry" style="margin-left:auto">Zkusit znovu</button>
    </div>

    <main>
      <!-- Weekly info (NEW) -->
      <section id="weekInfoSection" class="card hidden">
        <h2>Tento t√Ωden</h2>
        <p class="muted" id="weekInfoTextView"></p>
        <div id="weekInfoActivities" class="stack"></div>
      </section>

      <!-- Auth screen -->
      <section id="authSection" class="auth card">
        <h2>P≈ôihl√°≈°en√≠</h2>
        <p class="muted">Pou≈æijte firemn√≠ e-mail; prvn√≠ p≈ôihl√°≈°en√≠ vytvo≈ô√≠ v√°≈° profil (role p≈ôi≈ôad√≠ vedouc√≠).</p>
        <form id="authForm" class="stack">
          <div class="stack">
            <label for="email">E‚Äëmail</label>
            <input id="email" class="input" type="email" required placeholder="jan.novak@homecredit.cz" />
          </div>
          <div class="stack">
            <label for="password">Heslo</label>
            <input id="password" class="input" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          <div class="row">
            <button class="btn" type="submit">P≈ôihl√°sit / Registrovat</button>
            <button class="btn secondary" id="resetPass" type="button">Reset hesla</button>
          </div>
        </form>
      </section>

      <!-- Operator: quick self points -->
      <section id="operatorSection" class="card hidden">
        <h2>Moje aktivity</h2>
        <div class="stack">
          <div class="row">
            <select id="activitySelect" class="input" style="max-width:420px"></select>
            <input type="number" id="customDelta" class="input" placeholder="Vlastn√≠ poƒçet (¬±)" style="max-width:180px" />
            <button class="btn" id="addPointsBtn">P≈ôidat/Odebrat body</button>
          </div>
          <p class="muted" id="roleInfo"></p>
          <div id="myRecent" class="stack"></div>
        </div>
      </section>

      <!-- Leaderboard -->
      <section id="leaderboardSection" class="card hidden">
        <h2>≈Ωeb≈ô√≠ƒçek</h2>
        <div class="row muted" style="justify-content:space-between">
          <div>Body = nasb√≠ran√© d√°rky üéÅ</div>
          <div id="milestoneLegend"></div>
        </div>
        <div id="leaderboard" class="stack"></div>
      </section>

      <!-- Manager controls -->
      <section id="managerSection" class="hidden">
        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="cfg-activities">Aktivity</button>
          <button class="tab" data-tab="cfg-milestones">Miln√≠ky</button>
          <button class="tab" data-tab="cfg-roles">Role</button>
          <button class="tab" data-tab="cfg-utils">N√°stroje</button>
        </div>

        <div id="cfg-activities" class="card tabpanel">
          <h2>Nastaven√≠ aktivit</h2>
          <div class="row">
            <input id="actName" class="input" placeholder="N√°zev aktivity"/>
            <select id="actCategory" class="input">
              <option value="tel_weekly">Telefonie ‚Äì t√Ωdenn√≠</option>
              <option value="kore_static">Korespondence ‚Äì st√°l√©</option>
            </select>
            <input id="actPoints" class="input" type="number" placeholder="Body za splnƒõn√≠"/>
            <input id="actWeek" class="input" type="week" placeholder="T√Ωden (YYYY-Www)" title="Platnost pro t√Ωden (povinn√© pro t√Ωdenn√≠ aktivity)">
            <input id="actDesc" class="input" placeholder="Kr√°tk√Ω popis (voliteln√©)"/>
            <button class="btn" id="addActivity">P≈ôidat</button>
          </div>
          <div id="activitiesList" class="stack" style="margin-top:8px"></div>
        </div>

        <div id="cfg-milestones" class="card tabpanel hidden">
          <h2>Miln√≠ky</h2>
          <div class="row">
            <input id="msThreshold" class="input" type="number" placeholder="Poƒçet d√°rk≈Ø"/>
            <input id="msLabel" class="input" placeholder="Oznaƒçen√≠ (badge)"/>
            <button class="btn" id="addMilestone">P≈ôidat miln√≠k</button>
          </div>
          <div id="milestonesList" class="stack" style="margin-top:8px"></div>
        </div>

        <div id="cfg-roles" class="card tabpanel hidden">
          <h2>P≈ôi≈ôazen√≠ rol√≠</h2>
          <div class="row">
            <select id="userSelect" class="input" style="min-width:280px"></select>
            <select id="roleSelect" class="input">
              <option value="manager">manager</option>
              <option value="operator_tel">operator_tel</option>
              <option value="operator_tel_kore">operator_tel_kore</option>
              <option value="operator_kore">operator_kore</option>
            </select>
            <button class="btn" id="assignRole">Ulo≈æit roli</button>
          </div>
          <p class="muted">Role se ukl√°daj√≠ do kolekce <code>roles/{uid}</code>.</p>
          <div id="rolesList" class="stack" style="margin-top:8px"></div>
        </div>

        <div id="cfg-utils" class="card tabpanel hidden">
          <h2>N√°stroje</h2>
          <div class="stack">
            <div class="row">
              <button class="btn ghost" id="recomputeLeaderboard">P≈ôepoƒç√≠tat ≈æeb≈ô√≠ƒçek (klientsky)</button>
              <button class="btn ghost" id="exportLogs">Export log≈Ø (JSON)</button>
            </div>
            <div class="stack">
              <label for="weeklyInfoManager">Kr√°tk√Ω popis pro sekci ‚ÄûTento t√Ωden‚Äù</label>
              <textarea id="weeklyInfoManager" class="input" rows="3" placeholder="Nap≈ô. Tento t√Ωden bƒõ≈æ√≠ speci√°ln√≠ sprint pro telefonii‚Ä¶"></textarea>
              <div class="row" style="justify-content:flex-end"><button class="btn" id="saveWeekInfo">Ulo≈æit popis t√Ωdne</button></div>
            </div>
          </div>
          <p class="muted">Pozn.: Bez Cloud Functions prob√≠h√° p≈ôepoƒçet na klientovi. ≈Ωeb≈ô√≠ƒçek se poƒç√≠t√° ze souƒçtu dokument≈Ø v <code>logs</code>.</p>
        </div>
      </section>
    </main>

    <footer class="footer">¬© 2025 Home Credit ‚Ä¢ V√°noƒçn√≠ v√Ωzva ‚Ä¢ <span id="footerRole">Nep≈ôihl√°≈°en</span></footer>
  </div>

  <script type="module">
    // === Global error hooks (abychom hned vidƒõli chyby) ===
    window.addEventListener('error', (e)=>{ console.error('[window.error]', e.message, e.filename, e.lineno); });
    window.addEventListener('unhandledrejection', (e)=>{ console.error('[unhandledrejection]', e.reason); });

    // === Firebase bootstrap (modular v10) ===
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, query, where, orderBy, limit, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB3rsUPwZrAhSIUhNP5st0NnIoBR9nlpZE",
      authDomain: "santa-challenge.firebaseapp.com",
      projectId: "santa-challenge",
      storageBucket: "santa-challenge.firebasestorage.app",
      messagingSenderId: "499140073635",
      appId: "1:499140073635:web:6c82ed4fb5795b36174716"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);

    // === Theming ===
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(t){document.body.setAttribute('data-theme', t); localStorage.setItem('xx_theme', t);}    
    applyTheme(localStorage.getItem('xx_theme') || 'dark');
    themeToggle.addEventListener('click', ()=>{applyTheme((document.body.getAttribute('data-theme')==='dark')?'light':'dark')});

    // === Real-time banner helpers ===
    const rtBanner = document.getElementById('rtBanner');
    const rtStatusTag = document.getElementById('rtStatusTag');
    const rtStatusText = document.getElementById('rtStatusText');
    const rtRetry = document.getElementById('rtRetry');
    function showBanner(type, text){
      rtStatusTag.className = 'tag '+(type==='error'?'err':type==='warn'?'warn':'');
      rtStatusTag.textContent = type==='error'?'CHYBA': type==='warn'?'OFFLINE':'INFO';
      rtStatusText.textContent = text;
      rtBanner.classList.add('show');
    }
    function hideBanner(){ rtBanner.classList.remove('show'); }
    rtRetry.addEventListener('click', ()=>{ location.reload(); });
    function updateOnline(){
      if(navigator.onLine){ hideBanner(); }
      else { showBanner('warn', 'Jste offline. Zobrazuji posledn√≠ zn√°m√° data.'); }
    }
    window.addEventListener('online', updateOnline);
    window.addEventListener('offline', updateOnline);
    updateOnline();

    // === Elements ===
    const weekInfoSection = document.getElementById('weekInfoSection');
    const weekInfoTextView = document.getElementById('weekInfoTextView');
    const weekInfoActivities = document.getElementById('weekInfoActivities');

    const authSection = document.getElementById('authSection');
    const operatorSection = document.getElementById('operatorSection');
    const managerSection = document.getElementById('managerSection');
    const leaderboardSection = document.getElementById('leaderboardSection');
    const signOutBtn = document.getElementById('signOutBtn');
    const footerRole = document.getElementById('footerRole');
    const roleInfo = document.getElementById('roleInfo');

    const authForm = document.getElementById('authForm');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const resetPass = document.getElementById('resetPass');

    const activitySelect = document.getElementById('activitySelect');
    const addPointsBtn = document.getElementById('addPointsBtn');
    const customDelta = document.getElementById('customDelta');
    const myRecent = document.getElementById('myRecent');

    const milestoneLegend = document.getElementById('milestoneLegend');
    const leaderboard = document.getElementById('leaderboard');

    // Manager UI
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.tabpanel');
    tabs.forEach(t=>t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      panels.forEach(p=>p.classList.add('hidden'));
      document.getElementById(t.dataset.tab).classList.remove('hidden');
    }));

    const actName = document.getElementById('actName');
    const actCategory = document.getElementById('actCategory');
    const actPoints = document.getElementById('actPoints');
    const actWeek = document.getElementById('actWeek');
    const actDesc = document.getElementById('actDesc');
    const addActivity = document.getElementById('addActivity');
    const activitiesList = document.getElementById('activitiesList');

    const msThreshold = document.getElementById('msThreshold');
    const msLabel = document.getElementById('msLabel');
    const addMilestone = document.getElementById('addMilestone');
    const milestonesList = document.getElementById('milestonesList');

    const userSelect = document.getElementById('userSelect');
    const roleSelect = document.getElementById('roleSelect');
    const assignRole = document.getElementById('assignRole');
    const rolesList = document.getElementById('rolesList');

    const recomputeLeaderboard = document.getElementById('recomputeLeaderboard');
    const exportLogs = document.getElementById('exportLogs');

    // Settings (weekly info)
    const weeklyInfoManager = document.getElementById('weeklyInfoManager');
    const saveWeekInfo = document.getElementById('saveWeekInfo');

    // Data helpers
    const ROLE_LABELS = {
      manager: 'Vedouc√≠',
      operator_tel: 'Oper√°tor ‚Äì telefonie',
      operator_tel_kore: 'Oper√°tor ‚Äì p≈Ølen√≠ (tel + kore)',
      operator_kore: 'Oper√°tor ‚Äì korespondence'
    };
    function allowedCategoriesFor(role){
      if(role==='operator_tel') return ['tel_weekly'];
      if(role==='operator_kore') return ['kore_static'];
      if(role==='operator_tel_kore') return ['tel_weekly','kore_static'];
      if(role==='manager') return ['tel_weekly','kore_static'];
      return [];
    }

    function includeActivityThisWeek(a, role, now){
      if(!a || !a.enabled) return false;
      if(!allowedCategoriesFor(role).includes(a.category)) return false;
      if(a.category==='tel_weekly'){
        const start = a.weekStart?.seconds ? new Date(a.weekStart.seconds*1000) : (a.weekStart ? new Date(a.weekStart) : null);
        const end = a.weekEnd?.seconds ? new Date(a.weekEnd.seconds*1000) : (a.weekEnd ? new Date(a.weekEnd) : null);
        return !!(start && end && now >= start && now <= end);
      }
      // static correspondence
      return true;
    }

    // Auth flow
    authForm.addEventListener('submit', async(e)=>{
      e.preventDefault();
      const email = emailEl.value.trim();
      const pass = passEl.value.trim();
      try {
        try { await signInWithEmailAndPassword(auth, email, pass); }
        catch { await createUserWithEmailAndPassword(auth, email, pass); }
      } catch(err){ alert('Chyba p≈ôihl√°≈°en√≠/registrace: '+err.message); }
    });
    resetPass.addEventListener('click', async()=>{
      const email = emailEl.value.trim(); if(!email) return alert('Zadejte e‚Äëmail.');
      try{ await sendPasswordResetEmail(auth, email); alert('Odesl√°n reset hesla.'); }
      catch(err){ alert('Chyba: '+err.message); }
    });
    signOutBtn.addEventListener('click', ()=> signOut(auth));

    let currentUser = null; let currentRole = null; let unsubscribeActs = null; let unsubscribeMs = null; let unsubscribeSettings = null; let settingsRetryTimer = null;

    onAuthStateChanged(auth, async(user)=>{
      currentUser = user;
      if(!user){
        [authSection, weekInfoSection].forEach(e=>e.classList.remove('hidden'));
        operatorSection.classList.add('hidden');
        managerSection.classList.add('hidden');
        leaderboardSection.classList.add('hidden');
        footerRole.textContent = 'Nep≈ôihl√°≈°en';
        if(unsubscribeActs) unsubscribeActs();
        if(unsubscribeMs) unsubscribeMs();
        if(unsubscribeSettings) unsubscribeSettings();
        if(settingsRetryTimer) { clearInterval(settingsRetryTimer); settingsRetryTimer=null; }
        return;
      }
      // Ensure profile doc exists in operators/{uid}
      const opRef = doc(db, 'operators', user.uid);
      const opSnap = await getDoc(opRef);
      if(!opSnap.exists()){
        await setDoc(opRef, {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || user.email.split('@')[0],
          createdAt: serverTimestamp()
        });
      }
      // Fetch role from roles/{uid}
      const roleRef = doc(db, 'roles', user.uid);
      const roleSnap = await getDoc(roleRef);
      currentRole = roleSnap.exists() ? roleSnap.data().role : null;

      footerRole.textContent = currentRole ? `Role: ${ROLE_LABELS[currentRole] || currentRole}` : 'Role zat√≠m nep≈ôi≈ôazena';

      authSection.classList.add('hidden');
      leaderboardSection.classList.remove('hidden');
      weekInfoSection.classList.remove('hidden');

      if(currentRole==='manager'){
        managerSection.classList.remove('hidden');
        operatorSection.classList.remove('hidden');
      } else if(currentRole){
        operatorSection.classList.remove('hidden');
        managerSection.classList.add('hidden');
      } else {
        operatorSection.classList.add('hidden');
        managerSection.classList.add('hidden');
      }

      roleInfo.innerHTML = currentRole ? `Va≈°e role: <b>${ROLE_LABELS[currentRole]}</b>` : 'ƒåek√°te na p≈ôi≈ôazen√≠ role vedouc√≠m.';

      if(saveWeekInfo){ saveWeekInfo.disabled = currentRole !== 'manager'; }
      if(currentRole==='manager'){ await ensureSettingsDocExists(); }

      await Promise.all([
        subscribeActivities(),
        subscribeMilestones(),
        buildUsersForManager(),
        refreshLeaderboard(),
        loadMyRecent(),
        subscribeWeekInfo()
      ]);
    });

    // === Activities ===
    async function subscribeActivities(){
      const qActs = query(collection(db,'activities'), orderBy('name'));
      const handleErr = (err)=>{
        console.error('activities onSnapshot error', err);
        const m = err?.code==='permission-denied' ? 'Nem√°te opr√°vnƒõn√≠ ƒç√≠st aktivity.' : (err?.code==='unavailable' ? 'S√≠≈• nen√≠ dostupn√°.' : 'Nepoda≈ôilo se naƒç√≠st aktivity.');
        showBanner(err?.code==='unavailable'?'warn':'error', m);
      };
      unsubscribeActs = onSnapshot(qActs, (snap)=>{
        hideBanner();
        activitiesList.innerHTML = '';
        activitySelect.innerHTML = '';
        weekInfoActivities.innerHTML = '';
        const allowed = allowedCategoriesFor(currentRole);
        const now = new Date();
        const weeklyList = [];
        snap.forEach(d=>{
          const a = { id:d.id, ...d.data() };
          // Manager list row
          if(currentRole==='manager'){
            const row = document.createElement('div'); row.className='row';
            const start = a.weekStart?.seconds ? new Date(a.weekStart.seconds*1000) : (a.weekStart ? new Date(a.weekStart) : null);
            const end = a.weekEnd?.seconds ? new Date(a.weekEnd.seconds*1000) : (a.weekEnd ? new Date(a.weekEnd) : null);
            const weekInfo = (a.category==='tel_weekly') ? (a.week ? a.week : (start && end ? `${start.toLocaleDateString()} ‚Äì ${end.toLocaleDateString()}` : '<span class="muted">nenastaven t√Ωden</span>')) : '‚Äî';
            row.innerHTML = `
              <div class="card" style="flex:1; padding:10px; display:grid; grid-template-columns:1.2fr .6fr .8fr 1fr auto; gap:8px; align-items:center">
                <div><b>${a.name||'(bez n√°zvu)'}</b><div class=\"muted\">${a.category}${a.desc? ' ‚Ä¢ '+a.desc: ''}</div></div>
                <div>${Number(a.points)||0} bod≈Ø</div>
                <div>${a.enabled? 'Aktivn√≠' : '<span class=\"muted\">Skryto</span>'}</div>
                <div>${weekInfo}</div>
                <div class="row">
                  <button class="btn small ghost" data-toggle="${a.id}">P≈ôepnout</button>
                  <button class="btn small ghost" data-editdesc="${a.id}">Upravit popis</button>
                  <button class="btn small ghost" data-del="${a.id}">Smazat</button>
                </div>
              </div>`;
            activitiesList.appendChild(row);
            row.querySelector('[data-toggle]')?.addEventListener('click', async()=>{
              await updateDoc(doc(db,'activities', a.id), { enabled: !a.enabled });
            });
            row.querySelector('[data-del]')?.addEventListener('click', async()=>{
              if(confirm('Smazat aktivitu?')) await deleteDoc(doc(db,'activities', a.id));
            });
            row.querySelector('[data-editdesc]')?.addEventListener('click', async()=>{
              const val = prompt('Nov√Ω kr√°tk√Ω popis:', a.desc||'');
              if(val!==null){ await updateDoc(doc(db,'activities', a.id), { desc: val.trim() }); }
            });
          }
          // Operator dropdown ‚Äì filter by allowed category + enabled + (for weekly) within week window
          if(a.enabled && allowed.includes(a.category)){
            let include = true;
            if(a.category==='tel_weekly'){
              const start2 = a.weekStart?.seconds ? new Date(a.weekStart.seconds*1000) : (a.weekStart ? new Date(a.weekStart) : null);
              const end2 = a.weekEnd?.seconds ? new Date(a.weekEnd.seconds*1000) : (a.weekEnd ? new Date(a.weekEnd) : null);
              include = !!(start2 && end2 && now >= start2 && now <= end2);
            }
            if(include){
              const opt = document.createElement('option');
              opt.value = a.id; opt.textContent = `${a.name||'(bez n√°zvu)'} (+${Number(a.points)||0})`;
              opt.dataset.points = Number(a.points)||0;
              activitySelect.appendChild(opt);
            }
          }
          // Weekly info section list
          if(includeActivityThisWeek(a, currentRole, now)){
            weeklyList.push(a);
          }
        });
        // Render weekly info
        weeklyList.sort((x,y)=> (x.category||'').localeCompare(y.category||'') || (x.name||'').localeCompare(y.name||''));
        weeklyList.forEach(a=>{
          const start = a.weekStart?.seconds ? new Date(a.weekStart.seconds*1000) : (a.weekStart ? new Date(a.weekStart) : null);
          const end = a.weekEnd?.seconds ? new Date(a.weekEnd.seconds*1000) : (a.weekEnd ? new Date(a.weekEnd) : null);
          const meta = a.category==='tel_weekly' ? (a.week || (start && end ? `${start.toLocaleDateString()} ‚Äì ${end.toLocaleDateString()}` : '')) : 'st√°l√°';
          const card = document.createElement('div'); card.className='card';
          card.innerHTML = `
            <div class="row" style="justify-content:space-between; align-items:flex-start">
              <div>
                <div><b>${a.name||'(bez n√°zvu)'}</b> <span class="muted">(${meta})</span></div>
                ${a.desc? `<div class=\"muted\">${a.desc}</div>`:''}
              </div>
              <div><b>${Number(a.points)||0}</b> b.</div>
            </div>`;
          weekInfoActivities.appendChild(card);
        });
      }, handleErr);
    }

    addActivity?.addEventListener('click', async()=>{
      if(!actName.value || !actPoints.value) return alert('Dopl≈àte n√°zev a body.');
      const cat = actCategory.value;
      function weekToRange(weekStr){
        try{
          if(!weekStr) return null;
          const parts = weekStr.split('-W');
          const year = Number(parts[0]); const week = Number(parts[1]);
          if(!year || !week) return null;
          const simple = new Date(Date.UTC(year,0,1+ (week-1)*7));
          const dow = (simple.getUTCDay()+6)%7; // Mon=0..Sun=6
          const mon = new Date(simple); mon.setUTCDate(simple.getUTCDate()-dow);
          const sun = new Date(mon); sun.setUTCDate(mon.getUTCDate()+6);
          const monLocal = new Date(mon.getUTCFullYear(), mon.getUTCMonth(), mon.getUTCDate());
          const sunLocal = new Date(sun.getUTCFullYear(), sun.getUTCMonth(), sun.getUTCDate(), 23,59,59,999);
          return {week: weekStr, weekStart: monLocal, weekEnd: sunLocal};
        } catch(e){ return null; }
      }
      const wk = actWeek.value ? weekToRange(actWeek.value) : null;
      if(cat==='tel_weekly' && !wk) return alert('Pro t√Ωdenn√≠ aktivitu vyberte t√Ωden.');
      try{
        await addDoc(collection(db,'activities'), {
          name: actName.value.trim(),
          category: cat,
          points: Number(actPoints.value),
          enabled: true,
          desc: (actDesc.value||'').trim(),
          ...(wk||{}),
          createdAt: serverTimestamp()
        });
        actName.value=''; actPoints.value=''; actWeek.value=''; actDesc.value='';
      }catch(e){ alert('Chyba p≈ôid√°n√≠: '+e.message); }
    });

    // === Milestones ===
    async function subscribeMilestones(){
      const qMs = query(collection(db,'milestones'), orderBy('threshold'));
      const handleErr = (err)=>{
        console.error('milestones onSnapshot error', err);
        const m = err?.code==='permission-denied' ? 'Nem√°te opr√°vnƒõn√≠ ƒç√≠st miln√≠ky.' : (err?.code==='unavailable' ? 'S√≠≈• nen√≠ dostupn√°.' : 'Nepoda≈ôilo se naƒç√≠st miln√≠ky.');
        showBanner(err?.code==='unavailable'?'warn':'error', m);
      };
      unsubscribeMs = onSnapshot(qMs, (snap)=>{
        hideBanner();
        milestonesList.innerHTML = '';
        const items = []; snap.forEach(d=>items.push({id:d.id, ...d.data()}));
        milestoneLegend.textContent = items.length ? `Miln√≠ky: ${items.map(i=>i.threshold+ ' ‚Äì '+ i.label).join(' ‚Ä¢ ')}` : 'Miln√≠ky zat√≠m nejsou nastaven√©';
        items.forEach(m=>{
          const row = document.createElement('div'); row.className='row';
          row.innerHTML = `
            <div class="card" style="flex:1; padding:10px; display:grid; grid-template-columns:1fr 2fr auto; gap:8px; align-items:center">
              <div><b>${m.threshold}</b> bod≈Ø</div>
              <div>${m.label}</div>
              <div class="row">
                <button class="btn small ghost" data-del="${m.id}">Smazat</button>
              </div>
            </div>`;
          milestonesList.appendChild(row);
          row.querySelector('[data-del]')?.addEventListener('click', async()=>{
            if(confirm('Smazat miln√≠k?')) await deleteDoc(doc(db,'milestones', m.id));
          });
        });
      }, handleErr);
    }

    addMilestone?.addEventListener('click', async()=>{
      if(!msThreshold.value || !msLabel.value) return alert('Dopl≈àte hodnotu a popisek.');
      try{
        await addDoc(collection(db,'milestones'), { threshold: Number(msThreshold.value), label: msLabel.value.trim(), createdAt: serverTimestamp() });
        msThreshold.value=''; msLabel.value='';
      }catch(e){ alert('Chyba p≈ôid√°n√≠: '+e.message); }
    });

    // === Roles (manager) ===
    async function buildUsersForManager(){
      if(currentRole!=="manager") return;
      const ops = await getDocs(query(collection(db,'operators'), orderBy('email')));
      userSelect.innerHTML = ''; rolesList.innerHTML='';
      ops.forEach(d=>{
        const u = {id:d.id, ...d.data()};
        const opt = document.createElement('option'); opt.value = u.id; opt.textContent = `${u.email} (${u.displayName||u.id})`;
        userSelect.appendChild(opt);
      });
      // Render current roles
      const roleDocs = await getDocs(collection(db,'roles'));
      roleDocs.forEach(d=>{
        const r = {id:d.id, ...d.data()};
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<div class="row" style="justify-content:space-between"><div><b>${r.id}</b> ‚Üí ${ROLE_LABELS[r.role]||r.role}</div><button class="btn small ghost" data-remove="${r.id}">Odebrat</button></div>`;
        rolesList.appendChild(card);
        card.querySelector('[data-remove]')?.addEventListener('click', async()=>{
          if(confirm('Odebrat roli?')) await deleteDoc(doc(db,'roles', r.id));
          buildUsersForManager();
        });
      });
    }
    assignRole?.addEventListener('click', async()=>{
      try{
        await setDoc(doc(db,'roles', userSelect.value), { role: roleSelect.value, updatedAt: serverTimestamp() });
        alert('Role ulo≈æena.');
        buildUsersForManager();
      }catch(e){ alert('Chyba: '+e.message); }
    });

    // === Settings: Weekly info ===
    async function ensureSettingsDocExists(){
      try{
        const ref = doc(db,'settings','current_week_info');
        const s = await getDoc(ref);
        if(!s.exists()){
          await setDoc(ref, { text:'', createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
        }
      }catch(e){ console.warn('ensureSettingsDocExists failed (likely not manager):', e?.code||e?.message||e); }
    }

    async function subscribeWeekInfo(){
      const ref = doc(db,'settings','current_week_info');
      const handleErr = async (err)=>{
        console.error('settings onSnapshot error', err);
        const m = err?.code==='permission-denied' ? 'Chyb√≠ opr√°vnƒõn√≠ k nastaven√≠ t√Ωdne. Zkontrolujte roli (manager) a Firestore rules.' : (err?.code==='unavailable' ? 'S√≠≈• nen√≠ dostupn√°.' : 'Nepoda≈ôilo se naƒç√≠st nastaven√≠.');
        showBanner(err?.code==='unavailable'?'warn':'error', m);
        // Fallback: one-off fetch
        try{
          const one = await getDoc(ref);
          const data = one.exists()? one.data() : {text:''};
          weekInfoTextView.textContent = (data.text||'');
          if(currentRole==='manager') weeklyInfoManager.value = data.text||'';
        }catch(e){ console.warn('getDoc fallback for settings failed', e); }
      };
      try{
        if(unsubscribeSettings) unsubscribeSettings();
        unsubscribeSettings = onSnapshot(ref, (snap)=>{
          hideBanner();
          const data = snap.exists()? snap.data(): {text:''};
          weekInfoTextView.textContent = (data.text||'');
          if(currentRole==='manager') weeklyInfoManager.value = data.text||'';
        }, handleErr);
      }catch(err){ await handleErr(err); }
    }
    saveWeekInfo?.addEventListener('click', async()=>{
      try{
        if(currentRole!=='manager') return alert('Pouze manager m≈Ø≈æe mƒõnit popis t√Ωdne.');
        await setDoc(doc(db,'settings','current_week_info'), { text: weeklyInfoManager.value.trim(), updatedAt: serverTimestamp() }, { merge:true });
        alert('Popis t√Ωdne ulo≈æen');
      }catch(e){
        const msg = e?.code==='permission-denied' ? 'Chyb√≠ opr√°vnƒõn√≠ (role manager).' : e?.message;
        alert('Chyba ulo≈æen√≠: '+ msg);
      }
    });

    // === My recent logs with safe fallback (composite-index friendly) ===
    async function loadMyRecent(limitCount = 10){
      try{
        if(!currentUser){ myRecent.innerHTML = '<div class="muted">P≈ôihlaste se‚Ä¶</div>'; return; }
        let snap;
        try {
          const qLogs = query(
            collection(db,'logs'),
            where('uid','==', currentUser.uid),
            orderBy('createdAt','desc'),
            limit(limitCount)
          );
          snap = await getDocs(qLogs);
        } catch(err){
          console.warn('Fallback loadMyRecent reason:', err?.code||err?.message||err);
          const qLogsNoIndex = query(collection(db,'logs'), where('uid','==', currentUser.uid));
          const s2 = await getDocs(qLogsNoIndex);
          const arr = [];
          s2.forEach(d=>arr.push({id:d.id, ...d.data()}));
          arr.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
          myRecent.innerHTML = '';
          (arr.slice(0, limitCount)).forEach(l=>{
            const dt = l.createdAt?.seconds ? new Date(l.createdAt.seconds*1000) : new Date();
            const el = document.createElement('div'); el.className='card';
            const sign = (Number(l.delta)>=0? '+':'' )+ Number(l.delta);
            el.innerHTML = `<div class=\"row\" style=\"justify-content:space-between\">\n                <div><b>${l.activityName||l.activityId}</b><div class=\"muted\">${dt.toLocaleString()}</div></div>\n                <div><b>${sign}</b> b.</div>\n              </div>`;
            myRecent.appendChild(el);
          });
          return;
        }
        myRecent.innerHTML = '';
        if(snap.empty){
          myRecent.innerHTML = '<div class="muted">Zat√≠m ≈æ√°dn√© z√°znamy.</div>';
          return;
        }
        snap.forEach(d=>{
          const l = d.data();
          const dt = l.createdAt?.seconds ? new Date(l.createdAt.seconds*1000) : new Date();
          const el = document.createElement('div'); el.className='card';
          const sign = (Number(l.delta)>=0? '+':'' )+ Number(l.delta);
          el.innerHTML = `<div class=\"row\" style=\"justify-content:space-between\">\n              <div><b>${l.activityName||l.activityId}</b><div class=\"muted\">${dt.toLocaleString()}</div></div>\n              <div><b>${sign}</b> b.</div>\n            </div>`;
          myRecent.appendChild(el);
        });
      }catch(err){
        console.error('loadMyRecent failed', err);
        showBanner('error', 'Nepoda≈ôilo se naƒç√≠st z√°znamy: '+(err?.message||err));
        myRecent.innerHTML = `<div class=\"muted\">Nepoda≈ôilo se naƒç√≠st posledn√≠ z√°znamy: ${err.message}</div>`;
      }
    }

    // === Operator self add/remove points (writes logs) ===
    addPointsBtn?.addEventListener('click', async()=>{
      try{
        if(!currentUser) return alert('Nejprve se p≈ôihlaste.');
        const actId = activitySelect.value; if(!actId) return alert('Vyberte aktivitu.');
        const aSnap = await getDoc(doc(db,'activities', actId));
        if(!aSnap.exists()) return alert('Aktivita neexistuje.');
        const a = aSnap.data();
        const custom = Number(customDelta.value);
        const delta = Number.isFinite(custom) && custom !== 0 ? custom : Number(a.points||0);
        if(!Number.isFinite(delta) || delta===0) return alert('Zadejte platn√Ω poƒçet bod≈Ø (nenulov√Ω).');
        const entry = {
          uid: currentUser.uid,
          activityId: actId,
          activityName: a.name || actId,
          category: a.category,
          delta: delta,
          createdAt: serverTimestamp()
        };
        await addDoc(collection(db,'logs'), entry);
        customDelta.value='';
        await Promise.all([loadMyRecent(), refreshLeaderboard()]);
      }catch(err){
        console.error('addPoints error', err);
        const msg = err?.code==='permission-denied' ? 'Nem√°te opr√°vnƒõn√≠ p≈ôid√°vat body.' : (err?.code==='failed-precondition' ? 'Chyb√≠ index v datab√°zi.' : (err?.code==='unavailable' ? 'S√≠≈• nen√≠ dostupn√°.' : 'Nepoda≈ôilo se ulo≈æit z√°znam.'));
        showBanner(err?.code==='unavailable'?'warn':'error', msg);
        alert('Nepoda≈ôilo se ulo≈æit z√°znam: '+(err?.message||err));
      }
    });

    // Leaderboard = sum of logs per operator (client-side aggregation)
    async function refreshLeaderboard(){
      try{
        const opsSnap = await getDocs(collection(db,'operators'));
        const msSnap = await getDocs(query(collection(db,'milestones'), orderBy('threshold')));
        const milestones = []; msSnap.forEach(d=> milestones.push(d.data()));

        const ops = []; opsSnap.forEach(d=> ops.push({id:d.id, ...d.data()}));

        const sums = {};
        const logsSnap = await getDocs(collection(db,'logs'));
        logsSnap.forEach(d=>{ const l=d.data(); sums[l.uid]=(sums[l.uid]||0)+Number(l.delta||0)});

        const items = ops.map(o=>({ uid:o.id, name:o.displayName||o.email||o.id, total:sums[o.id]||0 }));
        items.sort((a,b)=> b.total - a.total);

        const medals = ['ü•á','ü•à','ü•â'];

        leaderboard.innerHTML = '';
        items.forEach((it,idx)=>{
          const card = document.createElement('div'); card.className='card';
          const achieved = milestones.filter(m=> it.total >= m.threshold).slice(-1)[0] || null;
          const achievedLabel = achieved ? achieved.label : null;
          const pctToNext = (()=>{
            if(!milestones.length) return 0;
            const higher = milestones.find(m=> it.total < m.threshold);
            if(!higher){ return 100; }
            const prev = milestones.filter(m=> m.threshold<=it.total).slice(-1)[0];
            const base = prev? prev.threshold: 0;
            const range = higher.threshold - base; const prog = it.total - base; return Math.max(0, Math.min(100, Math.round((prog/range)*100)));
          })();

          const nameHtml = `${it.name} ${idx<3? `<span class=\"medal\">${medals[idx]}</span>`:''} ${achievedLabel? `<span class=\"badge\" title=\"Dosa≈æen√Ω miln√≠k\">${achievedLabel}</span>`:''}`;

          card.innerHTML = `
            <div class="leaderboard-item">
              <div class="avatar">${it.name.substring(0,2).toUpperCase()}</div>
              <div>
                <div class="row" style="justify-content:space-between">
                  <div><b>${nameHtml}</b></div>
                  <div><b>${it.total}</b> b.</div>
                </div>
                <div class="progress" title="Postup k dal≈°√≠mu miln√≠ku">
                  <div class="bar" style="width:${pctToNext}%"></div>
                </div>
              </div>
              <div>#${idx+1}</div>
            </div>`;
          leaderboard.appendChild(card);
        });
      }catch(err){
        console.error('refreshLeaderboard error', err);
        showBanner(err?.code==='unavailable'?'warn':'error', 'Nepoda≈ôilo se naƒç√≠st ≈æeb≈ô√≠ƒçek.');
      }
    }

    // === Utility buttons ===
    recomputeLeaderboard?.addEventListener('click', ()=>{ refreshLeaderboard(); });
    exportLogs?.addEventListener('click', async()=>{
      try{
        const snap = await getDocs(collection(db,'logs'));
        const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
        const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='logs-export.json'; a.click(); URL.revokeObjectURL(url);
      }catch(e){ alert('Export selhal: '+e.message); }
    });

    // === Snow effect (simple canvas particles) ===
    const snowCanvas = document.getElementById('snow');
    const cx = snowCanvas.getContext('2d');
    let W,H; function resize(){ W = snowCanvas.width = window.innerWidth; H = snowCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    const flakes = Array.from({length: 140}, ()=>({ x: Math.random()*W, y: Math.random()*H, r: Math.random()*2+1, s: Math.random()*0.6+0.2, w: Math.random()*1.2+0.2 }));
    function tick(){ cx.clearRect(0,0,W,H); cx.globalAlpha=0.9; flakes.forEach(f=>{ cx.beginPath(); cx.arc(f.x, f.y, f.r, 0, Math.PI*2); cx.fillStyle='#fff'; cx.fill(); f.y += f.s; f.x += Math.sin(f.y*0.01)*f.w; if(f.y>H+5){ f.y=-5; f.x=Math.random()*W; } }); requestAnimationFrame(tick); }
    tick();

    // === Tiny self-tests (console) ===
    function runSelfTests(){
      const tests = [];
      const now = new Date();
      const yesterday = new Date(now.getTime()-86400000); const tomorrow = new Date(now.getTime()+86400000);
      tests.push({test:'include tel_weekly in range', pass: includeActivityThisWeek({enabled:true,category:'tel_weekly',weekStart:yesterday,weekEnd:tomorrow}, 'operator_tel', now)});
      tests.push({test:'exclude tel_weekly out of range', pass: !includeActivityThisWeek({enabled:true,category:'tel_weekly',weekStart:yesterday,weekEnd:yesterday}, 'operator_tel', now)});
      tests.push({test:'include kore_static always for kore role', pass: includeActivityThisWeek({enabled:true,category:'kore_static'}, 'operator_kore', now)});
      tests.push({test:'exclude disallowed category by role', pass: !includeActivityThisWeek({enabled:true,category:'kore_static'}, 'operator_tel', now)});
      tests.push({test:'loadMyRecent defined', pass: typeof loadMyRecent === 'function'});
      let safeCall = true; try{ const _p = loadMyRecent(1); }catch(e){ safeCall=false; }
      tests.push({test:'loadMyRecent does not throw without user', pass: safeCall});
      tests.push({test:'addPoints handler present', pass: !!addPointsBtn && addPointsBtn.onclick==null});
      tests.push({test:'subscribeWeekInfo defined', pass: typeof subscribeWeekInfo === 'function'});
      console.table(tests);
    }
    runSelfTests();
  </script>

  <!-- =============================
       FIREBASE FIRESTORE SECURITY RULES (kop√≠rujte **jen** blok n√≠≈æe do konzole Firebase)
       ============================= -->
  <!--
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function userId() { return request.auth.uid; }
    function userRole(u) { return get(/databases/$(database)/documents/roles/$(u)).data.role; }
    function isManager() { return userRole(userId()) == 'manager'; }
    function allowedCategoriesFor(role) {
      return role == 'manager' ? ['tel_weekly','kore_static'] :
             role == 'operator_tel' ? ['tel_weekly'] :
             role == 'operator_kore' ? ['kore_static'] :
             role == 'operator_tel_kore' ? ['tel_weekly','kore_static'] : [];
    }
    function categoryAllowedForCurrentUser(category) {
      return allowedCategoriesFor(userRole(userId())).hasAny([category]);
    }
    function activityCategory(actId) {
      return get(/databases/$(database)/documents/activities/$(actId)).data.category;
    }
    function activityWithinWeek(actId) {
      return get(/databases/$(database)/documents/activities/$(actId)).data.weekStart != null &&
             get(/databases/$(database)/documents/activities/$(actId)).data.weekEnd != null &&
             request.time >= get(/databases/$(database)/documents/activities/$(actId)).data.weekStart &&
             request.time <= get(/databases/$(database)/documents/activities/$(actId)).data.weekEnd;
    }

    // Roles
    match /roles/{uid} {
      allow read: if isSignedIn() && (uid == userId() || isManager());
      allow write: if isSignedIn() && isManager();
    }

    // Operators profiles
    match /operators/{uid} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && uid == userId();
      allow update: if isSignedIn() && uid == userId();
      allow delete: if isSignedIn() && isManager();
    }

    // Activities (managed by managers)
    match /activities/{id} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isManager();
    }

    // Milestones (managed by managers)
    match /milestones/{id} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isManager();
    }

    // Settings (weekly info text)
    match /settings/{doc} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isManager();
    }

    // Logs ‚Äì operators create entries only for themselves + allowed categories
    match /logs/{logId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.uid == userId()
        && exists(/databases/$(database)/documents/activities/$(request.resource.data.activityId))
        && categoryAllowedForCurrentUser(request.resource.data.category)
        && (activityCategory(request.resource.data.activityId) != 'tel_weekly' || activityWithinWeek(request.resource.data.activityId))
        && request.resource.data.keys().hasOnly(['uid','activityId','activityName','category','delta','createdAt'])
        && (request.resource.data.delta is int || request.resource.data.delta is float);

      allow update: if isSignedIn() && isManager();
      allow delete: if isSignedIn() && isManager();
    }

    match /{document=**} { allow read, write: if false; }
  }
}
-->

</body>
</html>
