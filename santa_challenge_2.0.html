<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Santa App Challenge</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #131a33;
      --muted: #9fb0ff;
      --accent: #ffd166;
      --ok: #4ade80;
      --danger: #f87171;
      --text: #e7ecff;
      --text-dim: #c2c9ff;
      --border: #24305e;
    }
    *{box-sizing:border-box}
    body {
      margin:0; background:linear-gradient(180deg,#0b1020,#0e1530 50%,#0b1020);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      min-height:100svh; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .container { width:100%; max-width:1100px; }
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; box-shadow:0 20px 50px rgba(0,0,0,.35);
    }
    h1,h2,h3{margin:0 0 12px}
    h1{font-size:28px}
    h2{font-size:22px}
    h3{font-size:18px; color:var(--muted)}
    p{color:var(--text-dim)}
    .grid{display:grid; gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){ .grid.cols-2,.grid.cols-3{grid-template-columns:1fr} }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .right{margin-left:auto}
    .btn {
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border); background:#1a2347; color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; text-decoration:none;
      transition:all .15s ease; user-select:none;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.3)}
    .btn.primary{background:linear-gradient(90deg,#6d83ff,#7aa7ff); color:#0b1020; border:none}
    .btn.ghost{background:transparent}
    .btn.warn{background:#2a1d1d; border-color:#5b2b2b; color:#ffd6d6}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input, select, textarea {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#0f1633; color:var(--text); outline:none;
    }
    input::placeholder{color:#97a4ff8c}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid var(--border)}
    th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
    th{color:var(--muted); font-weight:600; background:#11183a}
    tr:hover td{background:#0e1734}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--text-dim); font-size:12px}
    .muted{color:var(--text-dim)}
    .tag{font-size:12px; color:#0b1020; background:var(--accent); border-radius:999px; padding:4px 8px; font-weight:700}
    .hr{height:1px; background:var(--border); margin:12px 0}
    .hidden{display:none !important}
    .success{color:var(--ok)} .error{color:var(--danger)}
    .note{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">

    <!-- AUTH SCREEN -->
    <section id="auth-screen" class="card">
      <div class="grid cols-2">
        <div>
          <h1>üéÑ Santa App Challenge</h1>
          <p>V√°noƒçn√≠ soutƒõ≈æ pro oper√°tory: body za aktivace aplikace, prodej a efektivitu. P≈ôihlas se a nalo≈æ s√°nƒõ body!</p>
          <div class="hr"></div>
          <div class="grid">
            <button id="btn-google" class="btn primary">P≈ôihl√°sit p≈ôes Google</button>
            <div class="row">
              <div style="flex:1">
                <label>E-mail</label>
                <input id="email" type="email" placeholder="you@company.cz">
              </div>
              <div style="flex:1">
                <label>Heslo</label>
                <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              </div>
            </div>
            <div class="row">
              <button id="btn-signin" class="btn">P≈ôihl√°sit</button>
              <button id="btn-signup" class="btn ghost">Vytvo≈ôit √∫ƒçet</button>
            </div>
            <div id="auth-msg" class="note"></div>
          </div>
        </div>
        <div>
          <h3>Jak to funguje</h3>
          <ul>
            <li>Oper√°tor: zad√°v√° body jen sobƒõ, vid√≠ p≈ôehled a ≈æeb≈ô√≠ƒçek.</li>
            <li>Vedouc√≠: spr√°va aktivit, rol√≠, nastaven√≠ a p≈ôehled v≈°ech.</li>
            <li>Body se validuj√≠ proti definic√≠m aktivit (bez obch√°zen√≠ üòâ).</li>
          </ul>
          <p class="note">Tip: po prvn√≠m p≈ôihl√°≈°en√≠ si v konzoli Firestore nastav roli <b>manager</b> (viz n√°vod).</p>
        </div>
      </div>
    </section>

    <!-- APP SCREEN -->
    <section id="app-screen" class="card hidden">
      <div class="row">
        <h1>üéÑ Santa App Challenge</h1>
        <div class="right pill">
          <span id="user-name">‚Äî</span> ‚Ä¢ <span id="user-role">role‚Ä¶</span>
          <button id="btn-signout" class="btn ghost">Odhl√°sit</button>
        </div>
      </div>
      <div class="hr"></div>

      <!-- OPERATOR PANEL -->
      <section id="operator-panel">
        <div class="grid cols-3">
          <div>
            <h2>‚ûï P≈ôidat body</h2>
            <div class="grid">
              <div>
                <label>Aktivita</label>
                <select id="activity-select"></select>
              </div>
              <div>
                <label>Mno≈æstv√≠</label>
                <input id="quantity" type="number" min="1" value="1">
              </div>
              <div>
                <label>Pozn√°mka (nepovinn√©)</label>
                <input id="note" type="text" placeholder="nap≈ô. jm√©no klienta, pozn√°mka‚Ä¶">
              </div>
              <button id="btn-add-entry" class="btn primary">Ulo≈æit z√°pis</button>
              <div id="entry-msg" class="note"></div>
            </div>
          </div>

          <div>
            <h2>üìà M≈Øj p≈ôehled</h2>
            <div class="grid">
              <div class="pill"><b>Tento t√Ωden:</b> <span id="mine-week" class="right">0</span></div>
              <div class="pill"><b>Tento mƒõs√≠c:</b> <span id="mine-month" class="right">0</span></div>
              <div class="pill"><b>Sez√≥na:</b> <span id="mine-season" class="right">0</span></div>
            </div>
          </div>

          <div>
            <h2>üèÜ ≈Ωeb≈ô√≠ƒçek</h2>
            <div class="row">
              <select id="lb-range">
                <option value="week">T√Ωden</option>
                <option value="month">Mƒõs√≠c</option>
                <option value="season">Sez√≥na</option>
              </select>
              <button id="btn-refresh-lb" class="btn">Obnovit</button>
            </div>
            <div style="margin-top:8px; max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:12px">
              <table>
                <thead><tr><th>#</th><th>Jm√©no</th><th>Body</th></tr></thead>
                <tbody id="lb-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <h2>üßæ Moje posledn√≠ z√°pisy</h2>
        <div style="max-height:300px; overflow:auto; border:1px solid var(--border); border-radius:12px">
          <table>
            <thead>
              <tr><th>Datum</th><th>Aktivita</th><th>Mno≈æstv√≠</th><th>Body</th><th>Pozn√°mka</th><th></th></tr>
            </thead>
            <tbody id="my-entries"></tbody>
          </table>
        </div>
      </section>

      <!-- MANAGER PANEL -->
      <section id="manager-panel" class="hidden">
        <div class="hr"></div>
        <h2>üõ†Ô∏è Administrace</h2>
        <div class="grid cols-3">
          <!-- Aktivity -->
          <div>
            <h3>Aktivity</h3>
            <div class="grid">
              <label>N√°zev</label>
              <input id="act-name" placeholder="nap≈ô. Aktivace mobiln√≠ aplikace">
              <label>Body</label>
              <input id="act-points" type="number" min="1" value="10">
              <button id="btn-add-activity" class="btn">P≈ôidat/ulo≈æit aktivitu</button>
            </div>
            <div class="note" id="act-msg"></div>
            <div style="margin-top:8px; max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:12px">
              <table>
                <thead><tr><th>N√°zev</th><th>Body</th><th></th></tr></thead>
                <tbody id="act-list"></tbody>
              </table>
            </div>
          </div>

          <!-- U≈æivatel√© & role -->
          <div>
            <h3>U≈æivatel√© & role</h3>
            <div class="note">Vyhledej u≈æivatele a nastav mu roli (operator/manager).</div>
            <div class="grid">
              <label>Filtrovat podle e-mailu</label>
              <input id="user-filter" placeholder="ƒç√°st e-mailu‚Ä¶">
              <button id="btn-refresh-users" class="btn">Naƒç√≠st</button>
            </div>
            <div style="margin-top:8px; max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:12px">
              <table>
                <thead><tr><th>Jm√©no</th><th>E-mail</th><th>Role</th><th>Akce</th></tr></thead>
                <tbody id="users-list"></tbody>
              </table>
            </div>
          </div>

          <!-- Nastaven√≠ -->
          <div>
            <h3>Nastaven√≠</h3>
            <div class="grid">
              <label>N√°zev sez√≥ny</label>
              <input id="season-name" placeholder="V√°noce 2025">
              <label>Zaƒç√°tek sez√≥ny</label>
              <input id="season-start" type="date">
              <button id="btn-save-settings" class="btn">Ulo≈æit nastaven√≠</button>
              <div class="note" id="set-msg"></div>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <h3>üìú Posledn√≠ z√°pisy (v≈°ech)</h3>
        <div style="max-height:280px; overflow:auto; border:1px solid var(--border); border-radius:12px">
          <table>
            <thead>
              <tr><th>U≈æivatel</th><th>Datum</th><th>Aktivita</th><th>Mno≈æstv√≠</th><th>Body</th><th>Pozn√°mka</th><th></th></tr>
            </thead>
            <tbody id="all-entries"></tbody>
          </table>
        </div>
      </section>
    </section>
  </div>

  <!-- ≈†ablony ≈ô√°dk≈Ø -->
  <template id="tpl-my-entry">
    <tr>
      <td data-d="date"></td>
      <td data-d="activityName"></td>
      <td data-d="quantity"></td>
      <td data-d="points"></td>
      <td data-d="note"></td>
      <td class="row">
        <button class="btn ghost btn-edit">Upravit</button>
        <button class="btn warn btn-del">Smazat</button>
      </td>
    </tr>
  </template>

  <template id="tpl-all-entry">
    <tr>
      <td data-d="userName"></td>
      <td data-d="date"></td>
      <td data-d="activityName"></td>
      <td data-d="quantity"></td>
      <td data-d="points"></td>
      <td data-d="note"></td>
      <td class="row">
        <button class="btn ghost btn-edit">Upravit</button>
        <button class="btn warn btn-del">Smazat</button>
      </td>
    </tr>
  </template>

  <template id="tpl-activity">
    <tr>
      <td data-d="name"></td>
      <td data-d="points"></td>
      <td class="row">
        <button class="btn ghost btn-act-edit">Upravit</button>
        <button class="btn warn btn-act-del">Smazat</button>
      </td>
    </tr>
  </template>

  <script type="module">
    // ===== Firebase SDK importy (ESM z CDN) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider,
      signInWithPopup, signOut, setPersistence, browserLocalPersistence,
      signInWithEmailAndPassword, createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, addDoc, getDocs, query, where, orderBy, limit,
      serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ===== Inicializace Firebase =====
    const firebaseConfig = {
  	apiKey: "AIzaSyB3rsUPwZrAhSIUhNP5st0NnIoBR9nlpZE",
  	authDomain: "santa-challenge.firebaseapp.com",
  	projectId: "santa-challenge",
  	storageBucket: "santa-challenge.firebasestorage.app",
  	messagingSenderId: "499140073635",
  	appId: "1:499140073635:web:6c82ed4fb5795b36174716"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    setPersistence(auth, browserLocalPersistence);

    // ===== Pomocn√© =====
    const qs = (s, el=document)=>el.querySelector(s);
    const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
    const fmtDate = ts => {
      if (!ts) return "-";
      const d = ts instanceof Timestamp ? ts.toDate() : new Date(ts);
      return d.toLocaleString("cs-CZ", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
    };
    const startOfWeek = (d=new Date())=>{
      const dt=new Date(d); const day=(dt.getDay()+6)%7; // Po=0
      dt.setHours(0,0,0,0); dt.setDate(dt.getDate()-day); return dt;
    };
    const startOfMonth = (d=new Date())=>{
      const dt=new Date(d); dt.setHours(0,0,0,0); dt.setDate(1); return dt;
    };

    let currentUser = null;
    let currentRole = 'operator';
    let activitiesCache = new Map(); // id -> {name, points}
    let usersCache = new Map();      // uid -> {displayName, email}

    // ===== UI prvky =====
    const authScreen = qs('#auth-screen');
    const appScreen  = qs('#app-screen');
    const userNameEl = qs('#user-name');
    const userRoleEl = qs('#user-role');

    // Auth ovladaƒçe
    qs('#btn-google').onclick = async ()=>{
      try { await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch(e){ qs('#auth-msg').textContent = "P≈ôihl√°≈°en√≠ selhalo: " + e.message; }
    };
    qs('#btn-signin').onclick = async ()=>{
      const email = qs('#email').value.trim();
      const pass  = qs('#password').value;
      if(!email || !pass){ qs('#auth-msg').textContent="Zadej e-mail a heslo"; return; }
      try { await signInWithEmailAndPassword(auth, email, pass); }
      catch(e){ qs('#auth-msg').textContent = "P≈ôihl√°≈°en√≠ selhalo: " + e.message; }
    };
    qs('#btn-signup').onclick = async ()=>{
      const email = qs('#email').value.trim();
      const pass  = qs('#password').value;
      if(!email || !pass){ qs('#auth-msg').textContent="Zadej e-mail a heslo"; return; }
      try { await createUserWithEmailAndPassword(auth, email, pass); }
      catch(e){ qs('#auth-msg').textContent = "Registrace selhala: " + e.message; }
    };
    qs('#btn-signout').onclick = ()=>signOut(auth);

    // ===== Naƒçten√≠ role z Firestore (roles/{uid}) =====
    async function fetchRole(uid){
      const snap = await getDoc(doc(db,'roles',uid));
      return snap.exists() ? (snap.data().role || 'operator') : 'operator';
    }

    // ===== U≈æivatel: zaji≈°tƒõn√≠ users/{uid} dokumentu =====
    async function ensureUserDoc(user){
      const ref = doc(db,'users',user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          displayName: user.displayName || user.email?.split('@')[0] || 'U≈æivatel',
          email: user.email || '',
          createdAt: serverTimestamp()
        });
      }
    }

    // ===== Aktivity =====
    async function loadActivities(){
      activitiesCache.clear();
      const col = collection(db,'activities');
      const qy = query(col, orderBy('name'));
      const sn = await getDocs(qy);
      const sel = qs('#activity-select');
      sel.innerHTML = '';
      sn.forEach(d=>{
        const data=d.data();
        activitiesCache.set(d.id, {name:data.name, points:data.points});
        const opt=document.createElement('option');
        opt.value=d.id; opt.textContent = `${data.name} ‚Ä¢ ${data.points} b`;
        sel.appendChild(opt);
      });
    }

    // ===== Moje z√°pisy =====
    async function loadMyEntries(){
      const tbody = qs('#my-entries');
      tbody.innerHTML='';
      const qy = query(
        collection(db,'entries'),
        where('userId','==', currentUser.uid),
        orderBy('createdAt','desc'),
        limit(50)
      );
      const sn = await getDocs(qy);
      sn.forEach(docSnap=>{
        const e = docSnap.data();
        const tr = qs('#tpl-my-entry').content.cloneNode(true);
        tr.querySelector('[data-d="date"]').textContent = fmtDate(e.createdAt);
        tr.querySelector('[data-d="activityName"]').textContent = activitiesCache.get(e.activityId)?.name || e.activityId;
        tr.querySelector('[data-d="quantity"]').textContent = e.quantity;
        tr.querySelector('[data-d="points"]').textContent = e.points;
        tr.querySelector('[data-d="note"]').textContent = e.note || '';
        const row = tr.querySelector('tr');
        row.dataset.id = docSnap.id;
        row.dataset.activityId = e.activityId;
        row.querySelector('.btn-del').onclick = ()=> deleteEntry(docSnap.id);
        row.querySelector('.btn-edit').onclick = ()=> editEntry(row, e);
        tbody.appendChild(tr);
      });
    }

    async function deleteEntry(id){
      if (!confirm('Opravdu smazat z√°pis?')) return;
      await deleteDoc(doc(db,'entries',id));
      await refreshAll();
    }

    async function editEntry(row, e){
      const qty = prompt('Nov√© mno≈æstv√≠:', String(e.quantity));
      if (!qty) return;
      const quantity = parseInt(qty,10);
      if (isNaN(quantity) || quantity<1) return alert('Neplatn√© mno≈æstv√≠.');
      const note = prompt('Pozn√°mka (nepovinn√©):', e.note||'') || '';
      // Body se p≈ôepoƒç√≠taj√≠ podle aktivity (mus√≠ proj√≠t pravidly)
      const act = activitiesCache.get(row.dataset.activityId);
      const points = act.points * quantity;
      await updateDoc(doc(db,'entries',row.dataset.id), { quantity, note, points });
      await refreshAll();
    }

    // ===== P≈ôid√°n√≠ z√°pisu =====
    qs('#btn-add-entry').onclick = async ()=>{
      const actId = qs('#activity-select').value;
      const quantity = parseInt(qs('#quantity').value,10) || 1;
      const note = qs('#note').value.trim();
      const msg = qs('#entry-msg');
      if(!actId){ msg.textContent='Vyber aktivitu.'; return; }
      if(quantity<1){ msg.textContent='Mno≈æstv√≠ mus√≠ b√Ωt alespo≈à 1.'; return; }
      const act = activitiesCache.get(actId);
      const points = act.points * quantity; // serverovƒõ validov√°no v Rules
      try {
        await addDoc(collection(db,'entries'), {
          userId: currentUser.uid,
          activityId: actId,
          quantity,
          points,
          note,
          createdAt: serverTimestamp()
        });
        qs('#quantity').value = 1; qs('#note').value='';
        msg.textContent = 'Ulo≈æeno ‚úÖ'; setTimeout(()=>msg.textContent='',1800);
        await refreshAll();
      } catch(e){
        msg.textContent = 'Chyba p≈ôi ukl√°d√°n√≠: ' + e.message;
      }
    };

    // ===== ≈Ωeb≈ô√≠ƒçek =====
    async function loadLeaderboard(range='week'){
      const tbody = qs('#lb-body'); tbody.innerHTML='';
      const settings = await getSettings();
      const now = new Date();
      let from = new Date(2000,0,1);
      if (range === 'week') from = startOfWeek(now);
      if (range === 'month') from = startOfMonth(now);
      if (range === 'season' && settings?.seasonStart) from = new Date(settings.seasonStart);

      const qy = query(
        collection(db,'entries'),
        where('createdAt','>=', Timestamp.fromDate(from))
      );
      const sn = await getDocs(qy);
      const map = new Map(); // uid -> total points
      sn.forEach(d=>{
        const e=d.data();
        map.set(e.userId, (map.get(e.userId)||0)+ (e.points||0));
      });
      // zajistit jm√©na
      for (const uid of map.keys()) {
        if (!usersCache.has(uid)) {
          const uSnap = await getDoc(doc(db,'users',uid));
          usersCache.set(uid, uSnap.exists()? (uSnap.data()) : { displayName:'Nezn√°m√Ω', email:'' });
        }
      }
      const arr = [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,100);
      arr.forEach(([uid,total],i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${usersCache.get(uid)?.displayName||uid}</td><td><b>${total}</b></td>`;
        tbody.appendChild(tr);
      });
    }

    // ===== M≈Øj souhrn =====
    async function loadMyTotals(){
      const settings = await getSettings();
      const now = new Date();
      const ranges = {
        week: startOfWeek(now),
        month: startOfMonth(now),
        season: settings?.seasonStart ? new Date(settings.seasonStart) : new Date(2000,0,1)
      };
      for (const [key,from] of Object.entries(ranges)) {
        const qy = query(
          collection(db,'entries'),
          where('userId','==', currentUser.uid),
          where('createdAt','>=', Timestamp.fromDate(from))
        );
        const sn = await getDocs(qy);
        let sum=0; sn.forEach(d=>{ sum+=(d.data().points||0); });
        if (key==='week') qs('#mine-week').textContent = sum;
        if (key==='month') qs('#mine-month').textContent = sum;
        if (key==='season') qs('#mine-season').textContent = sum;
      }
    }

    // ===== Nastaven√≠ (settings/santa) =====
    async function getSettings(){
      const ref = doc(db,'settings','santa');
      const sn = await getDoc(ref);
      return sn.exists()? sn.data() : null;
    }
    async function saveSettings(data){
      await setDoc(doc(db,'settings','santa'), data, { merge:true });
    }

    // ===== Admin: Aktivity CRUD =====
    let editingActivityId = null;
    qs('#btn-add-activity').onclick = async ()=>{
      const name = qs('#act-name').value.trim();
      const points = parseInt(qs('#act-points').value,10);
      const msg = qs('#act-msg');
      if(!name || !points || points<1){ msg.textContent="Dopl≈à n√°zev i body."; return; }
      try{
        if (editingActivityId) {
          await updateDoc(doc(db,'activities',editingActivityId), { name, points });
          editingActivityId = null;
        } else {
          await addDoc(collection(db,'activities'), { name, points });
        }
        qs('#act-name').value=''; qs('#act-points').value=10;
        msg.textContent="Ulo≈æeno ‚úÖ"; setTimeout(()=>msg.textContent='',1500);
        await loadActivities(); await renderActivitiesAdmin();
      }catch(e){ msg.textContent="Chyba: "+e.message; }
    };

    async function renderActivitiesAdmin(){
      const tbody = qs('#act-list'); tbody.innerHTML='';
      // activitiesCache je naplnƒõn√© loadActivities()
      for (const [id, a] of [...activitiesCache.entries()].sort((x,y)=>x[1].name.localeCompare(y[1].name))) {
        const tr = qs('#tpl-activity').content.cloneNode(true);
        tr.querySelector('[data-d="name"]').textContent = a.name;
        tr.querySelector('[data-d="points"]').textContent = a.points;
        const row = tr.querySelector('tr');
        row.dataset.id = id;
        tr.querySelector('.btn-act-edit').onclick = ()=>{ editingActivityId=id; qs('#act-name').value=a.name; qs('#act-points').value=a.points; };
        tr.querySelector('.btn-act-del').onclick = async ()=>{
          if (confirm('Smazat aktivitu? Z√°pisy z≈Østanou, ale nep≈Øjdou znovu validovat p≈ôi √∫pravƒõ.')) {
            await deleteDoc(doc(db,'activities',id));
            await loadActivities(); await renderActivitiesAdmin();
          }
        };
        tbody.appendChild(tr);
      }
    }

    // ===== Admin: U≈æivatel√© & role =====
    qs('#btn-refresh-users').onclick = async ()=> renderUsersAdmin();
    async function renderUsersAdmin(){
      const filter = qs('#user-filter').value.trim().toLowerCase();
      const tbody = qs('#users-list'); tbody.innerHTML='';
      const sn = await getDocs(query(collection(db,'users'), orderBy('createdAt','desc'), limit(200)));
      for (const d of sn.docs) {
        const u = d.data();
        const uid = d.id;
        if (filter && !(u.email||'').toLowerCase().includes(filter)) continue;
        const roleSnap = await getDoc(doc(db,'roles',uid));
        const role = roleSnap.exists()? (roleSnap.data().role||'operator') : 'operator';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.displayName||'‚Äî'}</td>
          <td>${u.email||'‚Äî'}</td>
          <td><span class="tag">${role}</span></td>
          <td class="row">
            <button class="btn ghost">Nastavit operator</button>
            <button class="btn">Nastavit manager</button>
          </td>`;
        const [btnOp, btnMan] = tr.querySelectorAll('button');
        btnOp.onclick  = async ()=>{ await setDoc(doc(db,'roles',uid), { role:'operator' }); renderUsersAdmin(); };
        btnMan.onclick = async ()=>{ await setDoc(doc(db,'roles',uid), { role:'manager'  }); renderUsersAdmin(); };
        tbody.appendChild(tr);
        usersCache.set(uid, { displayName: u.displayName, email: u.email });
      }
    }

    // ===== Admin: Posledn√≠ z√°pisy v≈°ech =====
    async function loadAllEntries(){
      const tbody = qs('#all-entries'); tbody.innerHTML='';
      const qy = query(collection(db,'entries'), orderBy('createdAt','desc'), limit(100));
      const sn = await getDocs(qy);
      for (const d of sn.docs) {
        const e = d.data();
        if (!usersCache.has(e.userId)) {
          const us = await getDoc(doc(db,'users',e.userId));
          if (us.exists()) usersCache.set(e.userId, us.data());
        }
        const tr = qs('#tpl-all-entry').content.cloneNode(true);
        tr.querySelector('[data-d="userName"]').textContent = usersCache.get(e.userId)?.displayName || e.userId;
        tr.querySelector('[data-d="date"]').textContent = fmtDate(e.createdAt);
        tr.querySelector('[data-d="activityName"]').textContent = activitiesCache.get(e.activityId)?.name || e.activityId;
        tr.querySelector('[data-d="quantity"]').textContent = e.quantity;
        tr.querySelector('[data-d="points"]').textContent = e.points;
        tr.querySelector('[data-d="note"]').textContent = e.note || '';
        const row = tr.querySelector('tr');
        row.querySelector('.btn-del').onclick = ()=> deleteDoc(doc(db,'entries',d.id)).then(loadAllEntries);
        row.querySelector('.btn-edit').onclick = async ()=>{
          const qty = prompt('Nov√© mno≈æstv√≠:', String(e.quantity)); if (!qty) return;
          const quantity = parseInt(qty,10); if (isNaN(quantity)||quantity<1) return;
          const note = prompt('Pozn√°mka:', e.note||'') || '';
          const act = activitiesCache.get(e.activityId);
          const points = act.points * quantity;
          await updateDoc(doc(db,'entries',d.id), { quantity, note, points });
          await loadAllEntries(); await refreshAll();
        };
        tbody.appendChild(tr);
      }
    }

    // ===== Admin: Ulo≈æen√≠ nastaven√≠ =====
    qs('#btn-save-settings').onclick = async ()=>{
      const name = qs('#season-name').value.trim() || 'Sez√≥na';
      const start = qs('#season-start').value;
      const msg = qs('#set-msg');
      try{
        await saveSettings({ seasonName:name, seasonStart: start ? new Date(start).toISOString() : null });
        msg.textContent = 'Ulo≈æeno ‚úÖ'; setTimeout(()=>msg.textContent='',1500);
        await refreshAll();
      }catch(e){ msg.textContent = 'Chyba: '+e.message; }
    };

    qs('#btn-refresh-lb').onclick = ()=> loadLeaderboard(qs('#lb-range').value);
    qs('#lb-range').onchange = ()=> loadLeaderboard(qs('#lb-range').value);

    // ===== Refresh v≈°eho, kdy≈æ je nƒõco ulo≈æeno =====
    async function refreshAll(){
      await loadActivities();
      await loadMyEntries();
      await loadMyTotals();
      await loadLeaderboard(qs('#lb-range').value);
      if (currentRole==='manager') {
        await renderActivitiesAdmin();
        await renderUsersAdmin();
        await loadAllEntries();
        const st = await getSettings();
        if (st){ qs('#season-name').value = st.seasonName||''; qs('#season-start').value = st.seasonStart? st.seasonStart.slice(0,10):''; }
      }
    }

    // ===== Auth listener =====
    onAuthStateChanged(auth, async (user)=>{
      if (!user) {
        currentUser = null;
        authScreen.classList.remove('hidden');
        appScreen.classList.add('hidden');
        return;
      }
      currentUser = user;
      await ensureUserDoc(user);
      currentRole = await fetchRole(user.uid);
      userNameEl.textContent = user.displayName || user.email || 'U≈æivatel';
      userRoleEl.textContent = currentRole === 'manager' ? 'Vedouc√≠' : 'Oper√°tor';

      authScreen.classList.add('hidden');
      appScreen.classList.remove('hidden');
      qs('#manager-panel').classList.toggle('hidden', currentRole !== 'manager');

      await refreshAll();
    });
  </script>
</body>
</html>
